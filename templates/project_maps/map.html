<!-- filepath: /home/p102/django_projects/nova_workers_management/templates/project_maps/map.html -->
{% extends 'base.html' %}

{% block title %}
  Mapa de Proyectos
{% endblock %}

{% block extra_css %}
  <style>
    /* Estilos existentes... */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    
    .map-container {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      z-index: 10;
    }
    
    #project-map {
      height: 100%;
      width: 100%;
    }
    
    /* Panel lateral mejorado */
    .side-panel {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 380px;
      max-height: calc(100vh - 100px);
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .side-panel.collapsed {
      width: 60px;
      height: 60px;
    }
    
    .panel-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }
    
    .panel-content {
      padding: 16px;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }
    
    .side-panel.collapsed .panel-content {
      display: none;
    }
    
    /* Pesta√±as para diferentes secciones */
    .panel-tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }
    
    .panel-tab {
      flex: 1;
      padding: 8px 10px;
      text-align: center;
      cursor: pointer;
      font-size: 0.75rem;
      background: #f8f9fa;
      border: none;
      color: #6c757d;
      transition: all 0.2s ease;
    }
    
    .panel-tab.active {
      background: white;
      color: #495057;
      border-bottom: 2px solid #667eea;
    }
    
    .panel-tab:hover {
      background: #e9ecef;
    }
    
    /* Secciones desplegables */
    .collapsible-section {
      margin-bottom: 12px;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .section-header {
      background: #f8f9fa;
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
      font-weight: 500;
      color: #495057;
      border-bottom: 1px solid #e9ecef;
    }
    
    .section-header:hover {
      background: #e9ecef;
    }
    
    .section-content {
      padding: 12px;
      background: white;
      display: none;
    }
    
    .section-content.active {
      display: block;
    }
    
    .section-icon {
      transition: transform 0.3s ease;
    }
    
    .section-header.active .section-icon {
      transform: rotate(90deg);
    }
    
    /* Estad√≠sticas de provincias */
    .province-stats {
      margin-bottom: 16px;
    }
    
    .province-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      margin-bottom: 4px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 3px solid #667eea;
    }
    
    .province-item.employee-province {
      border-left-color: #28a745;
    }
    
    .province-name {
      font-weight: 500;
      color: #495057;
      flex: 1;
      font-size: 0.8rem;
    }
    
    .province-count {
      font-weight: 600;
      color: #667eea;
      margin-right: 8px;
      font-size: 0.8rem;
    }
    
    .province-count.employee-count {
      color: #28a745;
    }
    
    .province-percentage {
      font-size: 0.7rem;
      color: #6c757d;
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 10px;
    }
    
    /* Lista de proyectos */
    .project-item {
      padding: 8px 10px;
      margin-bottom: 4px;
      background: #fff5f5;
      border: 1px solid #fed7d7;
      border-radius: 4px;
      border-left: 3px solid #e53e3e;
    }
    
    .project-item.no-employees {
      background: #fffbeb;
      border-color: #fcd34d;
      border-left-color: #f59e0b;
    }
    
    .project-name {
      font-weight: 500;
      color: #2d3748;
      font-size: 0.8rem;
      margin-bottom: 2px;
    }
    
    .project-details {
      font-size: 0.7rem;
      color: #718096;
      line-height: 1.3;
    }
    
    /* Resumen general */
    .summary-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-bottom: 12px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .stat-label {
      font-size: 0.7rem;
      opacity: 0.9;
    }
    
    /* Scrollbar personalizado */
    .panel-content::-webkit-scrollbar {
      width: 4px;
    }
    
    .panel-content::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    .panel-content::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 2px;
    }
    
    .panel-content::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    .show-more-btn {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      color: #6c757d;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
    }
    
    .show-more-btn:hover {
      background: #e9ecef;
    }
    
    /* Estilos para proyectos sin empleados */
    .project-item.no-employees {
      background: #fffbeb;
      border-color: #fcd34d;
      border-left-color: #f59e0b;
    }
    
    .project-item.no-employees:hover {
      background: #fef3c7;
    }
    
    /* Mejoras visuales adicionales */
    .project-details div {
      margin-bottom: 2px;
    }
    
    .project-details div:last-child {
      margin-bottom: 0;
    }
    
    /* Botones de acci√≥n */
    .action-buttons {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-top: 12px;
    }
    
    .action-btn {
      display: inline-block;
      padding: 6px 12px;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 0.75rem;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .action-btn.primary {
      background: #667eea;
    }
    
    .action-btn.warning {
      background: #f59e0b;
    }
    
    .action-btn.success {
      background: #10b981;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="map-container">
    <div id="project-map">{{ map|safe }}</div>

    <!-- Panel lateral con estad√≠sticas -->
    <div class="side-panel" id="sidePanel">
      <div class="panel-header" onclick="togglePanel()">
        <span id="panelTitle">Estad√≠sticas</span>
        <i class="fas fa-chevron-right" id="panelIcon"></i>
      </div>

      <div class="panel-content">
        <!-- Pesta√±as -->
        <div class="panel-tabs">
          <button class="panel-tab active" onclick="showTab('overview')">General</button>
          <button class="panel-tab" onclick="showTab('provinces')">Provincias</button>
          <button class="panel-tab" onclick="showTab('issues')">Problemas</button>
        </div>

        <!-- PESTA√ëA GENERAL -->
        <div id="overviewTab" class="tab-content">
          <!-- Resumen general -->
          <div class="summary-stats">
            <div class="stat-card">
              <div class="stat-number">{{ total_projects_with_location }}</div>
              <div class="stat-label">Proyectos Ubicados</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">{{ total_projects_without_location }}</div>
              <div class="stat-label">Sin Ubicaci√≥n</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">{{ projects_without_employees|length }}</div>
              <div class="stat-label">Sin Empleados</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
              <div class="stat-number">{{ total_displaced_employees }}</div>
              <div class="stat-label">Desplazados</div>
            </div>
            <!-- A√±adir despu√©s de las estad√≠sticas existentes -->
            <div class="stat-card" style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);">
              <div class="stat-number">{{ big_projects_count }}</div>
              <div class="stat-label">Grandes Proyectos</div>
            </div>
          </div>

          <!-- Informaci√≥n adicional sobre marcadores -->
          <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; margin-top: 8px; font-size: 0.8rem;">
            <div style="font-weight: 500; color: #495057; margin-bottom: 6px;">
              <i class="fas fa-map-marker-alt mr-1"></i>Leyenda del Mapa
            </div>
            <div style="color: #6c757d; line-height: 1.4;">
              <div style="margin-bottom: 8px; font-weight: 500;">üìç Proyectos:</div>
              <div style="margin-left: 12px; margin-bottom: 4px;">
                <span style="color: #ff9800;">üåü</span> Naranjas: Trabajos sin empleados
              </div>
              <div style="margin-left: 12px; margin-bottom: 4px;">
                <span style="color: #007bff;">üè¢</span> Morados: Obras con empleados
              </div>
              <div style="margin-left: 12px; margin-bottom: 8px;">
                <span style="color: #28a745;">üü¢</span> Verdes: Proyectos con empleados
              </div>

              <div style="margin-bottom: 8px; font-weight: 500;">üë§ Empleados:</div>
              <div style="margin-left: 12px; margin-bottom: 4px;">
                <span style="color: #dc3545;">üî¥</span> Rojos: {{ total_displaced_employees }} empleados desplazados
              </div>
              <div style="margin-left: 12px;">
                <span style="color: #007bff;">üîµ</span> Azules: Empleados trabajando localmente
              </div>
              <!-- A√±adir en la leyenda de proyectos -->
              <div style="margin-left: 12px; margin-bottom: 4px;">
                <span style="color: #8B5CF6;">üíé</span> Morados: Grandes proyectos de inversi√≥n
              </div>
            </div>
          </div>

          <!-- Controles del mapa -->
          <div style="background: #e8f4f8; border: 1px solid #bee5eb; border-radius: 4px; padding: 8px; margin-top: 8px; font-size: 0.8rem;">
            <div style="font-weight: 500; color: #0c5460; margin-bottom: 4px;">
              <i class="fas fa-layer-group mr-1"></i>Control de Capas
            </div>
            <div style="color: #0c5460; font-size: 0.75rem;">
              Usa el control de capas en el mapa (esquina superior derecha) para mostrar/ocultar:
              <br />‚Ä¢ Proyectos internos ‚Ä¢ Proyectos externos ‚Ä¢ Empleados individuales
            </div>
          </div>>

          <!-- Estad√≠stica adicional de desplazados -->
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 8px; margin-top: 8px; font-size: 0.8rem;">
            <div style="font-weight: 500; color: #856404; margin-bottom: 4px;">
              <i class="fas fa-route mr-1"></i>Empleados Desplazados
            </div>
            <div style="color: #856404;">{{ total_displaced_employees }} empleados trabajan en una provincia diferente a su residencia</div>
            {% if total_displaced_employees > 0 %}
              <div style="color: #856404; font-size: 0.75rem; margin-top: 4px;">Estos proyectos aparecen con marcadores rojos (üî¥) en el mapa</div>
            {% endif %}
          </div>
        </div>

        <!-- PESTA√ëA PROVINCIAS -->
        <div id="provincesTab" class="tab-content" style="display: none;">
          <!-- Secci√≥n: Provincias por Proyectos -->
          <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection(this)">
              <span><i class="fas fa-building mr-1"></i>Proyectos por Provincia</span>
              <i class="fas fa-chevron-right section-icon"></i>
            </div>
            <div class="section-content">
              <!-- Top 5 provincias con m√°s proyectos -->
              <div class="province-stats">
                {% for province in top_project_provinces %}
                  <div class="province-item">
                    <div class="province-name">{{ province.name }}</div>
                    <div class="province-count">{{ province.project_count }}</div>
                    <div class="province-percentage">{{ province.percentage }}%</div>
                  </div>
                  <div style="font-size: 0.7rem; color: #6c757d; margin: 2px 0 8px 12px;">üë• {{ province.total_employees }} empleados trabajando aqu√≠</div>
                {% endfor %}
              </div>

              <!-- Resto de provincias (ocultas por defecto) -->
              {% if remaining_project_provinces %}
                <div id="remainingProjectProvinces" style="display: none;">
                  {% for province in remaining_project_provinces %}
                    <div class="province-item">
                      <div class="province-name">{{ province.name }}</div>
                      <div class="province-count">{{ province.project_count }}</div>
                      <div class="province-percentage">{{ province.percentage }}%</div>
                    </div>
                    <div style="font-size: 0.7rem; color: #6c757d; margin: 2px 0 8px 12px;">üë• {{ province.total_employees }} empleados trabajando aqu√≠</div>
                  {% endfor %}
                </div>
                <button class="show-more-btn" onclick="toggleMoreProvinces('project')"><span id="projectProvincesBtn">Ver todas las provincias ({{ remaining_project_provinces|length }} m√°s)</span></button>
              {% endif %}
            </div>
          </div>

          <!-- Secci√≥n: Empleados por Provincia de Trabajo -->
          <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection(this)">
              <span><i class="fas fa-briefcase mr-1"></i>Empleados por Provincia de Trabajo</span>
              <i class="fas fa-chevron-right section-icon"></i>
            </div>
            <div class="section-content">
              <div style="font-size: 0.75rem; color: #6c757d; margin-bottom: 8px; font-style: italic;">Empleados agrupados por la provincia donde trabajan (ubicaci√≥n del proyecto)</div>
              <div class="province-stats">
                {% for province in top_employee_project_provinces %}
                  <div class="province-item employee-province">
                    <div class="province-name">{{ province.name }}</div>
                    <div class="province-count employee-count">{{ province.employee_count }}</div>
                    <div class="province-percentage">{{ province.percentage }}%</div>
                  </div>
                {% endfor %}
              </div>

              {% if remaining_employee_project_provinces %}
                <div id="remainingEmployeeProjectProvinces" style="display: none;">
                  {% for province in remaining_employee_project_provinces %}
                    <div class="province-item employee-province">
                      <div class="province-name">{{ province.name }}</div>
                      <div class="province-count employee-count">{{ province.employee_count }}</div>
                      <div class="province-percentage">{{ province.percentage }}%</div>
                    </div>
                  {% endfor %}
                </div>
                <button class="show-more-btn" onclick="toggleMoreProvinces('employeeProject')"><span id="employeeProjectProvincesBtn">Ver todas las provincias ({{ remaining_employee_project_provinces|length }} m√°s)</span></button>
              {% endif %}
            </div>
          </div>

          <!-- Secci√≥n: Empleados por Provincia de Residencia -->
          <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection(this)">
              <span><i class="fas fa-home mr-1"></i>Empleados por Provincia de Residencia</span>
              <i class="fas fa-chevron-right section-icon"></i>
            </div>
            <div class="section-content">
              <div style="font-size: 0.75rem; color: #6c757d; margin-bottom: 8px; font-style: italic;">Empleados agrupados por su provincia de residencia</div>
              <div class="province-stats">
                {% for province in top_employee_residence_provinces %}
                  <div class="province-item" style="border-left-color: #ffc107;">
                    <div class="province-name">{{ province.name }}</div>
                    <div class="province-count" style="color: #ffc107;">{{ province.employee_count }}</div>
                    <div class="province-percentage">{{ province.percentage }}%</div>
                  </div>
                  <div style="font-size: 0.7rem; color: #6c757d; margin: 2px 0 8px 12px;">üè† {{ province.local_workers }} trabajan localmente ‚Ä¢ üöó {{ province.displaced_from_here }} desplazados</div>
                {% endfor %}
              </div>

              {% if remaining_employee_residence_provinces %}
                <div id="remainingEmployeeResidenceProvinces" style="display: none;">
                  {% for province in remaining_employee_residence_provinces %}
                    <div class="province-item" style="border-left-color: #ffc107;">
                      <div class="province-name">{{ province.name }}</div>
                      <div class="province-count" style="color: #ffc107;">{{ province.employee_count }}</div>
                      <div class="province-percentage">{{ province.percentage }}%</div>
                    </div>
                    <div style="font-size: 0.7rem; color: #6c757d; margin: 2px 0 8px 12px;">üè† {{ province.local_workers }} trabajan localmente ‚Ä¢ üöó {{ province.displaced_from_here }} desplazados</div>
                  {% endfor %}
                </div>
                <button class="show-more-btn" onclick="toggleMoreProvinces('employeeResidence')"><span id="employeeResidenceProvincesBtn">Ver todas las provincias ({{ remaining_employee_residence_provinces|length }} m√°s)</span></button>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- PESTA√ëA PROBLEMAS -->
        <div id="issuesTab" class="tab-content" style="display: none;">
          <!-- Secci√≥n: Empleados Desplazados -->
          <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection(this)">
              <span><i class="fas fa-route mr-1"></i>Empleados Desplazados ({{ total_displaced_employees }})</span>
              <i class="fas fa-chevron-right section-icon"></i>
            </div>
            <div class="section-content">
              <div style="font-size: 0.75rem; color: #6c757d; margin-bottom: 8px; font-style: italic;">Empleados que trabajan en una provincia diferente a su residencia</div>
              {% for displaced in displaced_employees %}
                <div class="project-item" style="background: #e3f2fd; border-color: #90caf9; border-left-color: #2196f3;">
                  <div class="project-name">{{ displaced.employee.name }}</div>
                  <div class="project-details">
                    <div>üè† Reside en: {{ displaced.employee_province }}</div>
                    <div>üíº Trabaja en: {{ displaced.project_province }}</div>
                    <div>üìã Proyecto: {{ displaced.project_name }}</div>
                  </div>
                </div>
              {% empty %}
                <p style="text-align: center; color: #28a745; font-style: italic; margin: 20px 0;">
                  <i class="fas fa-check-circle mr-2"></i>Todos los empleados trabajan en su provincia de residencia
                </p>
              {% endfor %}
            </div>
          </div>

          <!-- NUEVA SECCI√ìN: Proyectos sin empleados -->
          <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection(this)">
              <span><i class="fas fa-user-slash mr-1"></i>Proyectos Sin Empleados ({{ projects_without_employees|length }})</span>
              <i class="fas fa-chevron-right section-icon"></i>
            </div>
            <div class="section-content">
              <div style="font-size: 0.75rem; color: #6c757d; margin-bottom: 8px; font-style: italic;">Proyectos que no tienen ning√∫n empleado asignado</div>
              {% for item in projects_without_employees %}
                <div class="project-item no-employees">
                  <div class="project-name">{{ item.project.name }}</div>
                  <div class="project-details">
                    <div>üìç Provincia: {{ item.province }}</div>
                    <div>üèóÔ∏è Tipo: {{ item.project.type|default:'No especificado' }}</div>
                    <div>üë®‚Äçüíº Manager: {{ item.project.manager|default:'No asignado' }}</div>
                    {% if item.project.date_from %}
                      <div>üìÖ Inicio: {{ item.project.date_from|date:'d/m/Y' }}</div>
                    {% endif %}
                    {% if item.project.date_to %}
                      <div>üèÅ Fin: {{ item.project.date_to|date:'d/m/Y' }}</div>
                    {% endif %}
                  </div>
                </div>
              {% empty %}
                <p style="text-align: center; color: #28a745; font-style: italic; margin: 20px 0;">
                  <i class="fas fa-check-circle mr-2"></i>Todos los proyectos tienen empleados asignados
                </p>
              {% endfor %}

              {% if projects_without_employees %}
                <div style="text-align: center; margin-top: 12px;">
                  <a href="{% url 'kanban_board' %}" style="display: inline-block; padding: 6px 12px; background: #f59e0b; color: white; text-decoration: none; border-radius: 4px; font-size: 0.75rem; margin-right: 6px;"><i class="fas fa-users mr-1"></i>Asignar Empleados</a>
                  <a href="{% url 'employee_needed_create' %}" style="display: inline-block; padding: 6px 12px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-size: 0.75rem;"><i class="fas fa-plus mr-1"></i>Crear Necesidad</a>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Secci√≥n: Proyectos sin ubicaci√≥n -->
          <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection(this)">
              <span><i class="fas fa-map-marker-alt mr-1"></i>Sin Ubicaci√≥n ({{ total_projects_without_location }})</span>
              <i class="fas fa-chevron-right section-icon"></i>
            </div>
            <div class="section-content">
              {% if projects_without_location %}
                {% for project_id, project in projects_without_location.items %}
                  <div class="project-item">
                    <div class="project-name">{{ project.name }}</div>
                    <div class="project-details">
                      <div>üèóÔ∏è Tipo: {{ project.type }}</div>
                      <div>üë®‚Äçüíº Manager: {{ project.manager }}</div>
                      <div>üìç Provincia: {{ project.province }}</div>
                      <div>üë• Empleados: {{ project.employee_count }}</div>
                    </div>
                  </div>
                {% endfor %}

                <div style="text-align: center; margin-top: 12px;">
                  <a href="{% url 'employee_locations_list' %}" style="display: inline-block; padding: 6px 12px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-size: 0.75rem;"><i class="fas fa-cog mr-1"></i>Gestionar Ubicaciones</a>
                </div>
              {% else %}
                <p style="text-align: center; color: #28a745; font-style: italic; margin: 20px 0;">
                  <i class="fas fa-check-circle mr-2"></i>Todos los proyectos tienen ubicaci√≥n definida
                </p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let panelExpanded = true
    
    function togglePanel() {
      const panel = document.getElementById('sidePanel')
      const icon = document.getElementById('panelIcon')
      const title = document.getElementById('panelTitle')
    
      panelExpanded = !panelExpanded
    
      if (panelExpanded) {
        panel.classList.remove('collapsed')
        icon.className = 'fas fa-chevron-right'
        title.textContent = 'Estad√≠sticas'
      } else {
        panel.classList.add('collapsed')
        icon.className = 'fas fa-chevron-left'
        title.textContent = ''
      }
    }
    
    function showTab(tabName) {
      // Ocultar todas las pesta√±as
      document.querySelectorAll('.tab-content').forEach((tab) => {
        tab.style.display = 'none'
      })
    
      // Remover clase active de todas las pesta√±as
      document.querySelectorAll('.panel-tab').forEach((tab) => {
        tab.classList.remove('active')
      })
    
      // Mostrar la pesta√±a seleccionada
      const tabMap = {
        overview: 'overviewTab',
        provinces: 'provincesTab',
        issues: 'issuesTab'
      }
    
      document.getElementById(tabMap[tabName]).style.display = 'block'
    
      // A√±adir clase active a la pesta√±a clickeada
      event.target.classList.add('active')
    }
    
    function toggleSection(header) {
      const content = header.nextElementSibling
      const isActive = content.classList.contains('active')
    
      if (isActive) {
        content.classList.remove('active')
        header.classList.remove('active')
      } else {
        content.classList.add('active')
        header.classList.add('active')
      }
    }
    
    function toggleMoreProvinces(type) {
      let elementId, btnId
    
      // Mapear el tipo a los IDs correctos
      switch (type) {
        case 'project':
          elementId = 'remainingProjectProvinces'
          btnId = 'projectProvincesBtn'
          break
        case 'employeeProject':
          elementId = 'remainingEmployeeProjectProvinces'
          btnId = 'employeeProjectProvincesBtn'
          break
        case 'employeeResidence':
          elementId = 'remainingEmployeeResidenceProvinces'
          btnId = 'employeeResidenceProvincesBtn'
          break
        default:
          console.error('Tipo de provincia no reconocido:', type)
          return
      }
    
      const element = document.getElementById(elementId)
      const btn = document.getElementById(btnId)
    
      if (!element || !btn) {
        console.error('No se encontraron elementos:', elementId, btnId)
        return
      }
    
      if (element.style.display === 'none') {
        element.style.display = 'block'
        btn.textContent = 'Mostrar menos'
      } else {
        element.style.display = 'none'
        // Contar los elementos correctamente
        const itemCount = Math.floor(element.children.length / 2) // Dividir por 2 porque cada provincia tiene 2 divs
        btn.textContent = `Ver todas las provincias (${itemCount} m√°s)`
      }
    }
    
    // Auto-colapsar panel en pantallas peque√±as
    window.addEventListener('resize', function () {
      const panel = document.getElementById('sidePanel')
      if (window.innerWidth < 768 && panelExpanded) {
        togglePanel()
      }
    })
    
    // Abrir la primera secci√≥n por defecto
    document.addEventListener('DOMContentLoaded', function () {
      // Esperar a que todo el contenido se cargue
      setTimeout(function () {
        const firstSection = document.querySelector('.section-header')
        if (firstSection) {
          toggleSection(firstSection)
        }
      }, 100)
    })
  </script>
{% endblock %}
