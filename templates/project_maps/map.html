{% extends 'base.html' %}

{% block title %}Mapa de Proyectos{% endblock %}

{% block extra_css %}
<style>
    /* Hacer que el contenedor principal ocupe toda la altura disponible */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Evita barras de desplazamiento en el body */
    }
    
    /* Contenedor principal - ajustado para evitar desplazamiento */
    .map-container {
        position: fixed;
        top: 64px; /* Ajustar según la altura de tu header */
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        z-index: 10; /* Asegura que esté por encima del contenido normal pero debajo del header */
    }
    
    #project-map {
        height: 100%;
        width: 100%;
    }
    
    /* Panel lateral de proyectos sin ubicación */
    .side-panel {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 300px;
        max-height: calc(100vh - 100px);
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    /* Cuando está colapsado, solo mostrar el header */
    .side-panel.collapsed {
        width: 50px;
        height: 50px;
        overflow: hidden;
    }
    
    .panel-header {
        padding: 12px;
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .project-list {
        max-height: calc(100vh - 150px);
        overflow-y: auto;
        padding: 12px;
    }
    
    .project-card {
        transition: all 0.2s;
        margin-bottom: 8px;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
    }
    
    .project-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    /* Leyenda del mapa */
    .map-legend {
        position: absolute;
        bottom: 25px;
        left: 15px;
        background-color: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    
    .color-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    /* Asegurar que el contenido principal no se vea afectado por el mapa fijado */
    .content-spacer {
        height: 100vh;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Añadir un div vacío para mantener el espacio correcto en el layout -->
<div class="content-spacer"></div>

<!-- Panel de estadísticas para depuración -->
<div class="bg-white shadow-md rounded px-4 py-3 mb-4 fixed top-16 left-4 z-50">
    <h3 class="font-semibold text-gray-800 mb-2">Estadísticas del mapa</h3>
    <p><span class="font-medium">Proyectos con ubicación:</span> {{ project_count }}</p>
    <p><span class="font-medium">Empleados con ubicación:</span> {{ employee_count }}</p>
    {% if messages %}
        {% for message in messages %}
            <div class="mt-2 p-2 {{ message.tags }} rounded text-sm">{{ message }}</div>
        {% endfor %}
    {% endif %}
</div>

{% if geocoded_count > 0 %}
<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4" role="alert">
    <p>Se han geocodificado {{ geocoded_count }} empleados en esta sesión.</p>
</div>
{% endif %}

{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="bg-{{ message.tags|yesno:'green,yellow,red' }}-100 border-l-4 border-{{ message.tags|yesno:'green,yellow,red' }}-500 text-{{ message.tags|yesno:'green,yellow,red' }}-700 p-4 mb-4" role="alert">
        <p>{{ message }}</p>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="map-container">
    <!-- Mapa a pantalla completa -->
    <div id="project-map">
        {{ map|safe }}
    </div>
    
    <!-- Panel lateral colapsable -->
    <div class="side-panel" id="sidePanel">
        <div class="panel-header" id="panelHeader">
            <h3 class="font-semibold" id="panelTitle">Proyectos sin ubicación ({{ projects_without_location|length }})</h3>
            <button id="togglePanel" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <div class="project-list" id="projectList">
            {% if projects_without_location %}
                {% for project_id, project in projects_without_location.items %}
                    <div class="project-card bg-white hover:bg-gray-50">
                        <h4 class="font-medium">{{ project.name }}</h4>
                        <p class="text-sm text-gray-600">{{ project.type }} - {{ project.manager }}</p>
                        <div class="mt-2">
                            <a href="{% url 'add_project_location' project_id %}" class="text-orange-600 hover:text-orange-800 text-sm">
                                <i class="fas fa-map-marker-alt mr-1"></i> Añadir ubicación
                            </a>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-500 text-center py-4">Todos los proyectos tienen ubicación</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Leyenda del mapa -->
    <div class="map-legend">
        <div class="mb-2">
            <span class="color-indicator" style="background-color: #4ade80;"></span>
            <span>Proyectos</span>
        </div>
        <div class="mb-2">
            <span class="color-indicator" style="background-color: #a78bfa;"></span>
            <span>Obras</span>
        </div>
        <div class="mb-2">
            <span class="color-indicator" style="background-color: #3b82f6;"></span>
            <span>Otros</span>
        </div>
        <div>
            <span class="color-indicator" style="background-color: #ef4444;"></span>
            <span>Empleados</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Panel lateral colapsable
        const sidePanel = document.getElementById('sidePanel');
        const panelHeader = document.getElementById('panelHeader');
        const togglePanel = document.getElementById('togglePanel');
        const projectList = document.getElementById('projectList');
        const panelTitle = document.getElementById('panelTitle');
        
        let isPanelCollapsed = false;
        
        togglePanel.addEventListener('click', function() {
            isPanelCollapsed = !isPanelCollapsed;
            
            if (isPanelCollapsed) {
                sidePanel.classList.add('collapsed');
                togglePanel.innerHTML = '<i class="fas fa-chevron-left"></i>';
                projectList.style.display = 'none';
                panelTitle.style.display = 'none';
            } else {
                sidePanel.classList.remove('collapsed');
                togglePanel.innerHTML = '<i class="fas fa-chevron-right"></i>';
                projectList.style.display = 'block';
                panelTitle.style.display = 'block';
            }
        });
        
        // Asegurarse de que el mapa ocupe todo el espacio disponible
        const resizeMap = () => {
            const mapContainer = document.querySelector('.map-container');
            const headerHeight = document.querySelector('header')?.offsetHeight || 64;
            mapContainer.style.height = `calc(100vh - ${headerHeight}px)`;
        };
        
        // Resize al cargar y cuando cambia el tamaño de ventana
        resizeMap();
        window.addEventListener('resize', resizeMap);
    });
</script>
{% endblock %}