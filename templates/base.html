<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}Nova Workers Management{% endblock %}</title>
        
        <!-- Tailwind CSS - PRODUCCIÓN: Usar archivo compilado -->
        {% load static %}
        <!-- En producción: CSS compilado optimizado -->
        <link rel="stylesheet" href="{% static 'css/output.css' %}?v=20251007145035">
        
        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        
        <!-- Alpine.js - IMPORTANTE: Debe estar ANTES del cierre del head -->
        <script defer src="https://unpkg.com/@alpinejs/csp@3.x.x/dist/cdn.min.js"></script>
        
        <!-- Tu CSS personalizado -->
        {% load static %}
        <link rel="stylesheet" href="{% static 'css/base.css' %}">
        
        {% block extra_css %}{% endblock %}
    </head>
    <body class="bg-gray-50 min-h-screen flex flex-col ">
        <!-- Navigation -->
                <!-- Reemplazar los menús desplegables con esta versión -->
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 mr-4 order-first">
                            {% load static %}
                            <img src="{% static 'images/952.png' %}" alt="Nova Workers Logo" class="h-12 w-auto">
                        </div>
                        
                        <div class="hidden md:block">
                            <div class="ml-10 flex items-baseline space-x-4">
                                
                                <!-- Employees Menu -->
                                <div class="relative dropdown-container">
                                    <button class="dropdown-toggle text-orange-500 hover:text-orange-700 border-transparent inline-flex items-center px-1 pt-1 text-lg font-bold">
                                        <span>Employees</span>
                                        <svg class="ml-1 w-4 h-4 dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="dropdown-menu hidden origin-top-left absolute left-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                                        <a href="{% url 'employee_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">All Employees</a>
                                        <a href="{% url 'employee_create' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">Add Employee</a>
                                        <a href="{% url 'employee_locations_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">Manage Employee Locations</a>
                                        <a href="{% url 'get_employee_locked_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">Employee Locked List</a>
                                        <a href="{% url 'import_employees_csv' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">Import CSV</a>
                                        <a href="{% url 'export_employees_csv' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">Export CSV</a>
                                        <a href="{% url 'employee_vacation_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">Employee Vacations</a>
                                    </div>
                                </div>
                                
                                <!-- Projects Menu -->
                                <div class="relative dropdown-container">
                                    <button class="dropdown-toggle text-orange-500 hover:text-orange-700 border-transparent inline-flex items-center px-1 pt-1 text-lg font-bold">
                                        <span>Projects</span>
                                        <svg class="ml-1 w-4 h-4 dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="dropdown-menu hidden origin-top-left absolute left-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                                        <a href="{% url 'project_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">All Projects</a>
                                        <a href="{% url 'project_create' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">Add Project</a>
                                        <a href="{% url 'big_project_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">Manage Big Project Locations</a>
                                        <a href="{% url 'import_projects_csv' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">Import CSV</a>
                                        <a href="{% url 'export_projects_csv' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">Export CSV</a>
                                    </div>
                                </div>
        
                                <!-- Employee Needs Menu -->
                                <div class="relative dropdown-container">
                                    <button class="dropdown-toggle text-orange-500 hover:text-orange-700 border-transparent inline-flex items-center px-1 pt-1 text-lg font-bold">
                                        <span>Employee Needs</span>
                                        <svg class="ml-1 w-4 h-4 dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="dropdown-menu hidden origin-top-left absolute left-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                                        <a href="{% url 'employee_needed_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">All Requests</a>
                                        <a href="{% url 'employee_needed_create' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-200">Add Request</a>
                                    </div>
                                </div>
                                
                                <!-- Enlaces directos -->
                                <a href="{% url 'movement_list' %}" class="text-orange-500 hover:text-orange-700 border-transparent inline-flex items-center px-1 pt-1 text-lg font-bold">
                                    Movements
                                </a>
                                
                                <a href="{% url 'kanban_board' %}" class="text-orange-500 hover:text-orange-700 border-transparent inline-flex items-center px-1 pt-1 text-lg font-bold">
                                    Kanban Board
                                </a>
                                
                                <a href="{% url 'project_map' %}" class="text-orange-500 hover:text-orange-700 border-transparent inline-flex items-center px-1 pt-1 text-lg font-bold">
                                    <i class="fas fa-map-marked-alt mr-1"></i> Map
                                </a>
                                
                            </div>
                        </div>
                    </div>
                    
                    <!-- User menu -->
                    <div class="flex items-center">
                        {% if user.is_authenticated %}
                            <div class="relative dropdown-container">
                                <button class="dropdown-toggle flex items-center text-sm text-gray-500 hover:text-gray-700">
                                    <span class="mr-2">{{ user.username }}</span>
                                    <i class="fas fa-user-circle text-xl"></i>
                                </button>
                                <div class="dropdown-menu hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                                    <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </nav>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Inicializando dropdowns mejorados...');
                
                // Manejar todos los dropdowns
                const dropdownContainers = document.querySelectorAll('.dropdown-container');
                
                dropdownContainers.forEach(container => {
                    const toggle = container.querySelector('.dropdown-toggle');
                    const menu = container.querySelector('.dropdown-menu');
                    const arrow = container.querySelector('.dropdown-arrow');
                    
                    if (!toggle || !menu) return;
                    
                    // Asegurar z-index correcto
                    menu.style.zIndex = '2002';
                    container.style.zIndex = '2001';
                    
                    // Toggle del menú
                    toggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Cerrar otros menús
                        dropdownContainers.forEach(otherContainer => {
                            if (otherContainer !== container) {
                                const otherMenu = otherContainer.querySelector('.dropdown-menu');
                                const otherArrow = otherContainer.querySelector('.dropdown-arrow');
                                if (otherMenu) {
                                    otherMenu.classList.add('hidden');
                                    otherMenu.style.display = 'none';
                                }
                                if (otherArrow) {
                                    otherArrow.style.transform = 'rotate(0deg)';
                                }
                            }
                        });
                        
                        // Toggle del menú actual
                        const isHidden = menu.classList.contains('hidden');
                        if (isHidden) {
                            menu.classList.remove('hidden');
                            menu.style.display = 'block';
                            menu.style.position = 'absolute';
                            menu.style.zIndex = '2002';
                            if (arrow) arrow.style.transform = 'rotate(180deg)';
                            
                            // Asegurar posicionamiento correcto
                            setTimeout(() => {
                                const rect = toggle.getBoundingClientRect();
                                const menuRect = menu.getBoundingClientRect();
                                
                                // Si se sale por la derecha, ajustar
                                if (rect.left + menuRect.width > window.innerWidth) {
                                    menu.style.left = 'auto';
                                    menu.style.right = '0';
                                }
                                
                                // Si se sale por abajo, ajustar
                                if (rect.bottom + menuRect.height > window.innerHeight) {
                                    menu.style.top = 'auto';
                                    menu.style.bottom = '100%';
                                    menu.style.marginBottom = '0.5rem';
                                }
                            }, 10);
                        } else {
                            menu.classList.add('hidden');
                            menu.style.display = 'none';
                            if (arrow) arrow.style.transform = 'rotate(0deg)';
                        }
                    });
                    
                    // Mejorar hover para tablets/touch
                    if ('ontouchstart' in window) {
                        toggle.addEventListener('touchstart', function(e) {
                            e.preventDefault();
                            toggle.click();
                        });
                    }
                });
                
                // Cerrar menús al hacer click fuera
                document.addEventListener('click', function(e) {
                    dropdownContainers.forEach(container => {
                        const menu = container.querySelector('.dropdown-menu');
                        const arrow = container.querySelector('.dropdown-arrow');
                        if (menu && !container.contains(e.target)) {
                            menu.classList.add('hidden');
                            menu.style.display = 'none';
                            if (arrow) arrow.style.transform = 'rotate(0deg)';
                        }
                    });
                });
                
                // Cerrar menús con escape
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        dropdownContainers.forEach(container => {
                            const menu = container.querySelector('.dropdown-menu');
                            const arrow = container.querySelector('.dropdown-arrow');
                            if (menu) {
                                menu.classList.add('hidden');
                                menu.style.display = 'none';
                                if (arrow) arrow.style.transform = 'rotate(0deg)';
                            }
                        });
                    }
                });
                
                console.log(`Dropdowns mejorados inicializados: ${dropdownContainers.length}`);
                
                // Detectar scroll en columnas kanban para mostrar indicadores
                const kanbanColumns = document.querySelectorAll('.kanban-column');
                kanbanColumns.forEach(column => {
                    function updateScrollIndicators() {
                        const hasScroll = column.scrollHeight > column.clientHeight;
                        if (hasScroll) {
                            column.classList.add('has-scroll');
                        } else {
                            column.classList.remove('has-scroll');
                        }
                    }
                    
                    updateScrollIndicators();
                    column.addEventListener('scroll', updateScrollIndicators);
                    window.addEventListener('resize', updateScrollIndicators);
                });
            });
            </script>

        <!-- Messages -->
        <div class="content-container py-4">
            {% if messages %}
            <div id="messages-container" class="fixed top-4 right-4 z-50 max-w-md">
                {% for message in messages %}
                <div class="message {{ message.tags }} bg-{{ message.level_tag|default:'green' }}-100 border-l-4 border-{{ message.level_tag|default:'green' }}-500 text-{{ message.level_tag|default:'green' }}-700 p-4 mb-2 rounded shadow-md flex justify-between transition-all duration-500 ease-in-out transform translate-x-0 opacity-100 bg-green-600 text-white" role="alert">
                    <div>{{ message }}</div>
                    <button class="text-gray-500 hover:text-gray-800 ml-2" onclick="this.parentNode.remove()">×</button>
                </div>
                {% endfor %}
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const messages = document.querySelectorAll('.message');
                    messages.forEach(function(message) {
                        setTimeout(function() {
                            message.classList.replace('translate-x-0', 'translate-x-full');
                            message.classList.replace('opacity-100', 'opacity-0');
                            
                            setTimeout(function() {
                                message.remove();
                            }, 500);
                        }, 4000); // 4 segundos antes de desaparecer
                    });
                });
            </script>
            {% endif %}
        </div>

        <!-- Main Content -->
        <main class="flex-grow">
            <div class="content-container py-6">
                {% block content %}{% endblock %}
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200">
            <div class="content-container py-6">
                <p class="text-center text-sm text-gray-500">&copy; {% now "Y" %} Nova Cartografia Employee Management</p>
            </div>
        </footer>

        <!-- Alpine.js -->
        <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
        
        {% block extra_js %}{% endblock %}
    </body>
</html>