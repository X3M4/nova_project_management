<!-- filepath: /home/p102/django_projects/nova_workers_management/templates/novacartografia_employee_management/project_assign_employees.html -->
{% extends 'base.html' %}
{% load employee_filters %}

{% block title %}Gestionar Empleados - {{ project.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header del Proyecto -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">{{ project.name }}</h1>
                    <p class="text-sm text-gray-600 mt-1">
                        <i class="fas fa-user mr-1"></i>Manager: {{ project.manager|default:"No asignado" }}
                        <span class="ml-4"><i class="fas fa-map-marker-alt mr-1"></i>{{ project.state|default:"N/A" }}</span>
                    </p>
                </div>
                <a href="{% url 'kanban_board' %}" class="btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Volver al Kanban
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- SECCIÓN ASIGNACIONES -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <!-- Header Asignaciones -->
            <div class="bg-green-50 px-6 py-4 border-b border-green-200 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-green-800">
                        <i class="fas fa-user-plus mr-2"></i>
                        Asignar Empleados ({{ unassigned_employees|length }} disponibles)
                    </h2>
                    <div class="flex space-x-2">
                        <button type="button" id="btn-select-all-available" class="text-sm text-green-600 hover:text-green-800">
                            <i class="fas fa-check-double mr-1"></i>Todos
                        </button>
                        <button type="button" id="btn-clear-all-available" class="text-sm text-gray-600 hover:text-gray-800">
                            <i class="fas fa-times mr-1"></i>Ninguno
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de Empleados Disponibles -->
            <div class="p-4 max-h-96 overflow-y-auto" id="available-employees">
                {% for employee in unassigned_employees %}
                <div class="employee-card bg-gray-50 border border-gray-200 rounded-lg p-3 mb-2 hover:bg-green-50 hover:border-green-300 transition-all duration-200 cursor-pointer"
                     data-employee-id="{{ employee.id }}">
                    <div class="flex items-center">
                        <input type="checkbox" class="employee-checkbox h-4 w-4 text-green-600 rounded mr-3" value="{{ employee.id }}">
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                                {% if employee.match_percentage %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                    {% if employee.match_percentage >= 75 %}bg-green-100 text-green-800
                                    {% elif employee.match_percentage >= 50 %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ employee.match_percentage|floatformat:0 }}% compatible
                                </span>
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-600 mt-1">
                                <i class="fas fa-briefcase mr-1"></i>{{ employee.job }}
                                {% if employee.state %}
                                <span class="ml-2"><i class="fas fa-map-marker-alt mr-1"></i>{{ employee.state }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-users text-3xl mb-3"></i>
                    <p>No hay empleados disponibles</p>
                </div>
                {% endfor %}
            </div>

            <!-- Botón Asignar -->
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button type="button" id="btn-assign" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-user-plus mr-2"></i>
                    <span id="assign-text">Selecciona empleados para asignar</span>
                </button>
            </div>
        </div>

        <!-- SECCIÓN DESASIGNACIONES -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <!-- Header Desasignaciones -->
            <div class="bg-red-50 px-6 py-4 border-b border-red-200 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-red-800">
                        <i class="fas fa-user-minus mr-2"></i>
                        Desasignar Empleados ({{ current_employees|length }} asignados)
                    </h2>
                    <div class="flex space-x-2">
                        <button type="button" id="btn-select-all-current" class="text-sm text-red-600 hover:text-red-800">
                            <i class="fas fa-check-double mr-1"></i>Todos
                        </button>
                        <button type="button" id="btn-clear-all-current" class="text-sm text-gray-600 hover:text-gray-800">
                            <i class="fas fa-times mr-1"></i>Ninguno
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de Empleados Actuales -->
            <div class="p-4 max-h-96 overflow-y-auto" id="current-employees">
                {% for employee in current_employees %}
                <div class="employee-card bg-blue-50 border border-blue-200 rounded-lg p-3 mb-2 hover:bg-red-50 hover:border-red-300 transition-all duration-200 cursor-pointer"
                     data-employee-id="{{ employee.id }}">
                    <div class="flex items-center">
                        <input type="checkbox" class="employee-checkbox h-4 w-4 text-red-600 rounded mr-3" value="{{ employee.id }}">
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                            <div class="text-xs text-gray-600 mt-1">
                                <i class="fas fa-briefcase mr-1"></i>{{ employee.job }}
                                {% if employee.state %}
                                <span class="ml-2"><i class="fas fa-map-marker-alt mr-1"></i>{{ employee.state }}</span>
                                {% endif %}
                            </div>
                            <div class="text-xs text-blue-600 mt-1">
                                <i class="fas fa-calendar-check mr-1"></i>Asignado al proyecto
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-user-slash text-3xl mb-3"></i>
                    <p>No hay empleados asignados</p>
                </div>
                {% endfor %}
            </div>

            <!-- Botón Desasignar -->
            {% if current_employees %}
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button type="button" id="btn-unassign" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-user-minus mr-2"></i>
                    <span id="unassign-text">Selecciona empleados para desasignar</span>
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- JavaScript Simplificado -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Inicializando gestión de empleados...');
    
    const PROJECT_ID = {{ project.id }};
    
    // Elementos
    const btnAssign = document.getElementById('btn-assign');
    const btnUnassign = document.getElementById('btn-unassign');
    const btnSelectAllAvailable = document.getElementById('btn-select-all-available');
    const btnClearAllAvailable = document.getElementById('btn-clear-all-available');
    const btnSelectAllCurrent = document.getElementById('btn-select-all-current');
    const btnClearAllCurrent = document.getElementById('btn-clear-all-current');
    
    const assignText = document.getElementById('assign-text');
    const unassignText = document.getElementById('unassign-text');
    
    // Configurar event listeners para tarjetas y checkboxes
    setupEmployeeCards();
    
    // Botones de selección masiva
    if (btnSelectAllAvailable) {
        btnSelectAllAvailable.addEventListener('click', () => selectAll('available'));
    }
    if (btnClearAllAvailable) {
        btnClearAllAvailable.addEventListener('click', () => clearAll('available'));
    }
    if (btnSelectAllCurrent) {
        btnSelectAllCurrent.addEventListener('click', () => selectAll('current'));
    }
    if (btnClearAllCurrent) {
        btnClearAllCurrent.addEventListener('click', () => clearAll('current'));
    }
    
    // Botones principales
    if (btnAssign) {
        btnAssign.addEventListener('click', handleAssign);
    }
    if (btnUnassign) {
        btnUnassign.addEventListener('click', handleUnassign);
    }
    
    // Configurar tarjetas de empleados
    function setupEmployeeCards() {
        const cards = document.querySelectorAll('.employee-card');
        
        cards.forEach(card => {
            const checkbox = card.querySelector('.employee-checkbox');
            
            // Click en tarjeta
            card.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    checkbox.checked = !checkbox.checked;
                    updateCardStyle(card, checkbox.checked);
                    updateButtonStates();
                }
            });
            
            // Change en checkbox
            checkbox.addEventListener('change', function() {
                updateCardStyle(card, this.checked);
                updateButtonStates();
            });
        });
    }
    
    // Actualizar estilo de tarjeta
    function updateCardStyle(card, selected) {
        if (selected) {
            card.classList.add('ring-2', 'ring-blue-500');
            card.classList.remove('hover:bg-green-50', 'hover:bg-red-50');
        } else {
            card.classList.remove('ring-2', 'ring-blue-500');
            card.classList.add(card.closest('#available-employees') ? 'hover:bg-green-50' : 'hover:bg-red-50');
        }
    }
    
    // Seleccionar todos
    function selectAll(type) {
        const container = type === 'available' ? '#available-employees' : '#current-employees';
        const checkboxes = document.querySelectorAll(`${container} .employee-checkbox`);
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            updateCardStyle(checkbox.closest('.employee-card'), true);
        });
        
        updateButtonStates();
    }
    
    // Limpiar selección
    function clearAll(type) {
        const container = type === 'available' ? '#available-employees' : '#current-employees';
        const checkboxes = document.querySelectorAll(`${container} .employee-checkbox`);
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            updateCardStyle(checkbox.closest('.employee-card'), false);
        });
        
        updateButtonStates();
    }
    
    // Actualizar estado de botones
    function updateButtonStates() {
        const selectedAvailable = document.querySelectorAll('#available-employees .employee-checkbox:checked');
        const selectedCurrent = document.querySelectorAll('#current-employees .employee-checkbox:checked');
        
        // Botón asignar
        if (assignText) {
            if (selectedAvailable.length > 0) {
                assignText.textContent = `Asignar ${selectedAvailable.length} empleado${selectedAvailable.length > 1 ? 's' : ''}`;
            } else {
                assignText.textContent = 'Selecciona empleados para asignar';
            }
        }
        
        // Botón desasignar
        if (unassignText) {
            if (selectedCurrent.length > 0) {
                unassignText.textContent = `Desasignar ${selectedCurrent.length} empleado${selectedCurrent.length > 1 ? 's' : ''}`;
            } else {
                unassignText.textContent = 'Selecciona empleados para desasignar';
            }
        }
    }
    
    // Manejar asignación
    function handleAssign() {
        const selected = document.querySelectorAll('#available-employees .employee-checkbox:checked');
        
        if (selected.length === 0) {
            alert('⚠️ Selecciona al menos un empleado para asignar');
            return;
        }
        
        const employeeIds = Array.from(selected).map(cb => parseInt(cb.value));
        console.log('🔄 Asignando empleados:', employeeIds);
        
        // Deshabilitar botón
        btnAssign.disabled = true;
        btnAssign.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Asignando ${selected.length} empleado${selected.length > 1 ? 's' : ''}...`;
        
        // Realizar petición
        fetch('{% url "assign_employees_to_project" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                project_id: PROJECT_ID,
                employee_ids: employeeIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(`✅ ${data.assigned_count || selected.length} empleado${data.assigned_count > 1 ? 's asignados' : ' asignado'} correctamente`, 'success');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage(`❌ Error: ${error.message}`, 'error');
        })
        .finally(() => {
            btnAssign.disabled = false;
            updateButtonStates();
        });
    }
    
    // Manejar desasignación
    function handleUnassign() {
        const selected = document.querySelectorAll('#current-employees .employee-checkbox:checked');
        
        if (selected.length === 0) {
            alert('⚠️ Selecciona al menos un empleado para desasignar');
            return;
        }
        
        const confirmMsg = `¿Estás seguro de desasignar ${selected.length} empleado${selected.length > 1 ? 's' : ''} del proyecto?`;
        if (!confirm(confirmMsg)) return;
        
        const employeeIds = Array.from(selected).map(cb => parseInt(cb.value));
        console.log('🔄 Desasignando empleados:', employeeIds);
        
        // Deshabilitar botón
        btnUnassign.disabled = true;
        btnUnassign.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Desasignando ${selected.length} empleado${selected.length > 1 ? 's' : ''}...`;
        
        // Realizar petición
        fetch('{% url "unassign_employees_from_project" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                employee_ids: employeeIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(`✅ ${data.unassigned_count || selected.length} empleado${data.unassigned_count > 1 ? 's desasignados' : ' desasignado'} correctamente`, 'success');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage(`❌ Error: ${error.message}`, 'error');
        })
        .finally(() => {
            btnUnassign.disabled = false;
            updateButtonStates();
        });
    }
    
    // Funciones auxiliares
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }
    
    function showMessage(message, type) {
        const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
        messageDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(messageDiv);
        
        // Mostrar
        setTimeout(() => messageDiv.classList.remove('translate-x-full'), 100);
        
        // Ocultar
        setTimeout(() => {
            messageDiv.classList.add('translate-x-full');
            setTimeout(() => messageDiv.remove(), 300);
        }, 4000);
    }
    
    console.log('✅ Gestión de empleados inicializada');
});
</script>

<!-- CSRF Token -->
{% csrf_token %}
{% endblock %}