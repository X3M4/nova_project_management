{% extends 'base.html' %}
{% load employee_filters %}

{% block title %}
Kanban Board
{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/kanban.css' %}" />
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/drag_drop.js' %}"></script>
{% endblock %}

{% block content %}
<div class="kanban-container">
  <!-- Header with search and controls -->
  <div class="kanban-header bg-white shadow-sm mb-4 p-4 rounded-lg">
    <div class="flex justify-between items-center">
      <div class="flex gap-2">
        
          <a href="{% url 'project_list' %}"
            class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded flex items-center text-sm mr-2 inline-block"><i
              class="fas fa-th-list mr-2"></i> Project List</a>
      </div>

      <!-- Search Bar -->
      <div class="flex-1 max-w-md mx-6">
        <form method="GET" class="relative" id="search-form">
          <input type="text" name="search" value="{{ request.GET.search }}" id="search-input"
            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="Buscar proyectos, managers, empleados..." />
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400"></i>
          </div>
          {% if request.GET.search %}
          <a href="{% url 'kanban_board' %}" class="absolute inset-y-0 right-0 pr-3 flex items-center"><i
              class="fas fa-times text-gray-400 hover:text-gray-600"></i></a>
          {% endif %}
        </form>
      </div>

      <!-- Statistics -->
      {% if stats.employees_ending_soon > 0 or stats.employees_on_vacation > 0 or stats.employees_ending_contract > 0 or stats.employees_contract_ending_soon > 0 %}
      <div class="stats-panel w-full max-w-2xl">
        {% if stats.employees_ending_soon > 0 %}
        <div class="alert alert-warning text-sm text-red-500 mb-2">
          <i class="fas fa-exclamation-triangle"></i>
          <span>{{ stats.employees_ending_soon }}</span> Empleados con fin de obra próximo (7 días):
          {% for employee in employees %}
            {% if employee.is_ending_soon %}
              <span class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full mr-1 mb-1">
                {{ employee.name }}
                {% if employee.end_date %}
                  - {{ employee.end_date|date:'d/m/Y' }}
                {% endif %}
              </span>
            {% endif %}
          {% endfor %}
        </div>
        {% endif %}

        {% if stats.employees_ending_contract > 0 %}
        <div class="alert alert-warning text-sm text-orange-600 mb-2">
          <i class="fas fa-skull-crossbones"></i>
          <span>{{ stats.employees_ending_contract }}</span> Empleados con fin de contrato marcado:
          {% for employee in employees %}
            {% if employee.end_contract %}
              <span class="inline-block bg-orange-100 text-purple-800 text-xs px-2 py-1 rounded-full mr-1 mb-1">
                {{ employee.name }}
                {% if employee.end_contract_date %}
                  - {{ employee.end_contract_date|date:'d/m/Y' }}
                {% endif %}
              </span>
            {% endif %}
          {% endfor %}
        </div>
        {% endif %}


        <div class="alert alert-info text-sm">
          <i class="fas fa-umbrella-beach text-blue-600"></i>
          <span id="stat-upcoming-vacations"></span> Vacaciones próxios 8 días:
          {% for employee in employees %}
          {% if employee.near_upcoming_vacation %}
            <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-1 mb-1">{{ employee.name }} 
              {% if employee.vacations_to %}
                - {{ employee.vacations_to|date:'d/m/Y' }}
              {% endif %}
            </span>
          {% endif %}
          {% endfor %}
        </div>

        
        <div class="alert alert-info text-sm">
          <i class="fas fa-umbrella-beach text-orange-600"></i>
          <span id="stat-on-vacation"></span> Empleados de vacaciones:
          {% for employee in employees %}
          {% if employee.on_vacation %}
            <span class="inline-block bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full mr-1 mb-1">{{ employee.name }}
              {% if employee.vacations_to %}
                - {{ employee.vacations_to|date:'d/m/Y' }}
              {% endif %}
            </span>
          {% endif %}
          {% endfor %}
        </div>
        {% endif %}
      </div>
      
    </div>
  </div>

  <!-- Main Kanban Layout -->
  <div class="kanban-board">
    <!-- Sidebar with unassigned employees -->
    <div class="kanban-sidebar">
      <div class="p-4 h-full flex flex-col max-h-[calc(100vh-2rem)]">
      <h3 class="text-lg font-bold text-gray-700 mb-4 text-center flex-shrink-0">EL PUCHERO</h3>
      <div class="bg-white shadow rounded-lg overflow-hidden flex-1 flex flex-col min-h-0">
        <div class="bg-gray-100 px-3 py-2 border-b border-gray-200 flex-shrink-0">
        <div class="flex justify-between items-center">
          <h4 class="text-sm font-medium text-gray-800">Disponibles</h4>
          <span class="bg-gray-200 text-xs font-medium rounded-full px-2 py-1 text-gray-800">({{ employees|count_unassigned }})</span>
        </div>
        </div>
        <div class="kanban-column flex-1 overflow-y-scroll overflow-x-hidden p-2 min-h-0" 
             id="unassigned-column" 
             data-project-id="null" 
             style="
               scrollbar-width: thick !important; 
               scrollbar-color: #374151 #e5e7eb !important;
               min-height: 400px !important;
               max-height: calc(100vh - 300px) !important;
             ">
        {% for employee in employees %}
        {% if not employee.project_id and employee.active %}
        <div class="employee-card{% if employee.locked == False %}{% if 'topógrafo' in employee.job|lower %} bg-green-300{% elif 'auxiliar' in employee.job|lower %} bg-yellow-200{% elif 'proyecto' in employee.job|lower %} bg-orange-300{% elif 'piloto' in employee.job|lower %} bg-blue-300{% else %} bg-white{% endif %}{% else %} bg-gray-200{% endif %} border border-gray-300 rounded-md shadow-sm mb-2 cursor-move p-3" 
             data-employee-id="{{ employee.id }}" draggable="true">
          <div class="flex justify-between items-start">
          <div class="flex-1">
            <h4 class="employee-name">{{ employee.name }}</h4>
            <p class="employee-job">{{ employee.job }}</p>
            {% if employee.city %}
            <p class="text-xs text-gray-500 mt-1">
            <i class="fas fa-map-marker-alt mr-1"></i>{{ employee.city }}
            </p>
            {% endif %}
          </div>
          <div class="flex flex-col items-end">
            <a href="{% url 'employee_update' employee.id %}" class="text-blue-600 hover:text-blue-800"><i
              class="fas fa-external-link-alt text-xs"></i></a>
          </div>
          </div>

          <!-- Employee skills indicators -->
          <div class="flex justify-between mt-2 text-xs">
          <div class="{% if employee.driver_license %}
                text-green-600
              {% else %}
                text-red-500
              {% endif %}">
            <i class="fas fa-id-card"></i>
          </div>
          <div class="{% if employee.twenty_hours %}
                text-green-600
              {% else %}
                text-red-500
              {% endif %}">
            <span>20h</span>
          </div>
          <div class="{% if employee.sixty_hours %}
                text-green-600
              {% else %}
                text-red-500
              {% endif %}">
            <span>60h</span>
          </div>
          <div class="{% if employee.confine %}
                text-green-600
              {% else %}
                text-red-500
              {% endif %}">
            <i class="fas fa-square-person-confined"></i>
          </div>
          <div class="{% if employee.height %}
                text-green-600
              {% else %}
                text-red-500
              {% endif %}">
            <i class="fas fa-person-falling"></i>
          </div>

          {% if employee.on_vacation %}
          <div class="text-orange-500" title="De vacaciones">
            <i class="fas fa-umbrella-beach text-2xl"></i>
          </div>
          {% elif employee.near_upcoming_vacation %}
          <div class="text-blue-500" title="Vacaciones próximas">
            <i class="fas fa-umbrella-beach text-2xl"></i>
          </div>
          {% elif employee.end_contract %}
          <div class="text-indigo-500" title="Contrato termina">
            <i class="fas fa-skull-crossbones text-xl"></i>
            <p class="text-sm text-gray-600">{{ employee.end_contract_date|date:'d/m/Y' }}</p>
          </div>
          {% endif %}
          </div>
        </div>
        {% endif %}
        {% endfor %}
        </div>
      </div>
      </div>
    </div>

    <!-- Main content with project boards -->
    <div class="kanban-main">
      <!-- OBRAS Section (First Row) -->
      <div class="mb-6">
        <div class="section-title">
          <h3>
            <i class="fas fa-hard-hat mr-2"></i>
            OBRAS
          </h3>
        </div>

        <div class="projects-container" id="obras-container">
          {% for project in projects %}
          {% if project.type|lower == 'external' %}
          <div class="project-column">
            <!-- Project Header -->
            <div class="project-header bg-violet-200 border-b-4
                     {% if project.manager == 'Jose Cuesta Mejías' %}
                      border-emerald-400

                    {% elif project.manager == 'Javier Marín Gimeno' %}
                      border-orange-400

                    {% elif project.manager == 'Guillermo Boscá Gómez' %}
                      border-yellow-400

                    {% elif project.manager == 'Miguel Ángel Martínez García' %}
                      border-violet-400

                    {% elif project.manager == 'Óscar López Valverde' %}
                      border-rose-500

                    {% else %}
                      border-gray-400

                    {% endif %}">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <h3 class="project-title text-violet-800">{{ project.name }}</h3>
                  <div class="project-meta text-gray-600">
                    {% if project.date_from %}
                    <div class="text-xs">
                      <i class="fas fa-calendar mr-1"></i>
                      Desde: {{ project.date_from|date:'d/m/Y' }}
                    </div>
                    {% endif %}
                    {% if project.date_to %}
                    <div class="text-xs">
                      <i class="fas fa-calendar-check mr-1"></i>
                      Hasta: {{ project.date_to|date:'d/m/Y' }}
                    </div>
                    {% endif %}
                    {% if project.manager %}
                    <div class="text-xs font-medium mt-1">
                      <i class="fas fa-user-tie mr-1"></i>
                      {{ project.manager }}
                    </div>
                    {% endif %}
                    {% if project.description %}
                    <div class="text-xs font-medium mt-1 bg-violet-100">
                        <i class="fas fa-comment mr-1 text-violet-500"></i>
                      {{ project.description }}
                    </div>
                    {% endif %}
                  </div>
                </div>
                <div class="flex flex-col items-end">
                  <a href="{% url 'project_detail' project.id %}" class="text-violet-600 hover:text-violet-800"><i
                      class="fas fa-external-link-alt text-sm"></i></a>
                </div>
              </div>
              <div class="flex items-center justify-between w-full mt-2 gap-1">
                          <a href="{% url 'project_detail' project.id %}" 
                             class="text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 flex-1 text-center" 
                             title="Ver detalles del proyecto">
                            <i class="fas fa-eye text-lg"></i>
                          </a>
                          <a href="{% url 'project_update' project.id %}" 
                             class="text-green-600 hover:text-green-800 p-1 rounded hover:bg-green-100 flex-1 text-center" 
                             title="Editar proyecto">
                            <i class="fas fa-edit text-lg"></i>
                          </a>
                          <a href="{% url 'project_assign_employees' project.id %}" 
                             class="text-purple-600 hover:text-purple-800 p-1 rounded hover:bg-purple-100 flex-1 text-center" 
                             title="Asignar empleados">
                            <i class="fas fa-user-plus text-lg"></i>
                          </a>
                          <a href="{% url 'employee_needed_create' %}?project_id={{ project.id }}" 
                             class="text-orange-600 hover:text-orange-800 p-1 rounded hover:bg-orange-100 flex-1 text-center" 
                             title="Crear necesidad de empleado">
                            <i class="fas fa-user-clock text-lg"></i>
                          </a>
                          <a href="{% url 'get_employee_locked_create' %}?project_id={{ project.id }}" 
                             class="text-indigo-600 hover:text-indigo-800 p-1 rounded hover:bg-indigo-100 flex-1 text-center" 
                             title="Reservar empleado">
                            <i class="fas fa-lock text-lg"></i>
                          </a>
                          <a href="{% url 'project_delete' project.id %}" 
                             class="text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 flex-1 text-center" 
                             title="Eliminar proyecto"
                             onclick="return confirm('¿Estás seguro de que quieres eliminar este proyecto?')">
                            <i class="fas fa-trash text-lg"></i>
                          </a>
                        </div>
                        
            </div>
            


            <!-- Employees in this project -->
            <div class="kanban-column bg-violet-100" id="project-{{ project.id }}-column" data-project-id="{{ project.id }}">

              {% for need in needs %}
                    {% if need.project_id == project %}
                      <div class="need-card p-2 bg-red-300 border border-gray-300 rounded-md shadow-sm mb-2">
                        <div class="flex justify-between items-start">
                          <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-900">{{ need.get_type_display }}</h4>
                            <p class="text-sm text-gray-600">{{ need.quantity }} required</p>
                            {% if need.description %}
                              <p class="text-xs text-gray-700 mt-1 italic">{{ need.description|truncatewords:10 }}</p>
                            {% endif %}
                          </div>
                          <div class="flex flex-col items-end">
                            <p class="text-sm text-gray-500">{{ need.start_date }}</p>
                            {% if need.id %}
                              <div class="flex space-x-1 mt-1">
                                <a href="{% url 'employee_needed_update' need.id %}" class="text-rose-600 hover:text-gray-600" title="Edit request"><i class="fas fa-edit text-base"></i></a>
                                <a href="{% url 'employee_needed_fulfill' need.id %}" class="text-green-600 hover:text-green-800" title="Mark as fulfilled"><i class="fas fa-check-circle text-base"></i></a>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}

                  {% for lock in locks %}
                    {% if lock.next_project == project %}
                      <div class="lock-card p-2 bg-indigo-500 border border-gray-300 rounded-md shadow-sm mb-2">
                        <div class="justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-white">{{ lock.employee }}</h4>
                          </div>
                          <div>
                            <p class="text-sm text-gray-100 text-white">{{ lock.start_date }}</p>
                            <p class="text-sm text-gray-100 text-white">{{ lock.end_date }}</p>
                            {% if lock.id %}
                              <div class="flex space-x-2 ml-2">
                                <a href="{% url 'get_employee_locked_update' lock.id %}" class="text-white hover:text-gray-600" title="Edit request"><i class="fas fa-edit text-base"></i></a>
                                <a href="{% url 'get_employee_locked_fulfill' lock.id %}" class="text-lime-300 hover:text-green-800" title="Mark as fulfilled"><i class="fas fa-check-circle text-base"></i></a>
                                <a href="{% url 'get_employee_locked_delete' lock.id %}" 
                                  class="text-amber-400 hover:text-orange-700" 
                                  title="Delete lock"
                                  onclick="return confirm('¿Estás seguro de que quieres eliminar esta reserva?')">
                                  <i class="fas fa-trash text-base"></i>
                                </a>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}

              {% for employee in employees %}
              {% if employee.project_id == project and employee.active %}
              <div class="employee-card
                        {% if employee.locked == False %}
                            {% if 'Topógrafo' in employee.job or 'TOPÓGRAFO' in employee.job %}
                              
                            bg-green-300

                            {% elif 'Auxiliar' in employee.job or 'auxiliar' in employee.job %}
                              
                            bg-yellow-200

                            {% elif 'Proyectos' in employee.job or 'Proyecto' in employee.job %}
                              
                            bg-orange-300

                            {% elif 'Piloto' in employee.job or 'piloto' in employee.job %}
                              
                            bg-blue-300

                            {% else %}
                              
                            bg-green-100 hover:bg-green-200

                            {% endif %}
                          {% else %}
                            
                          bg-gray-200

                          {% endif %}
                        border border-gray-300 rounded-md shadow-sm mb-2 cursor-move"
                data-employee-id="{{ employee.id }}" draggable="true">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <h4 class="employee-name">{{ employee.name }}</h4>
                    <p class="employee-job">{{ employee.job }}</p>
                    {% if employee.city %}
                    <p class="text-xs text-gray-500 mt-1">
                      <i class="fas fa-map-marker-alt mr-1"></i>{{ employee.city }}
                    </p>
                    {% endif %}
                    {% if employee.end_date %}
                    <p class="text-xs text-red-600 mt-1">
                      <i class="fas fa-clock mr-1"></i>
                      Hasta: {{ employee.end_date|date:'d/m/Y' }}
                    </p>
                    {% endif %}
                  </div>
                  <div class="flex flex-col items-end">
                    <a href="{% url 'employee_update' employee.id %}" class="text-blue-600 hover:text-blue-800"><i
                        class="fas fa-external-link-alt text-xs"></i></a>
                  </div>
                </div>

                <!-- Employee skills indicators -->
                <div class="flex justify-between mt-2 text-xs">
                  <div class="{% if employee.driver_license %}
                                text-green-600
                              {% else %}
                                text-red-500
                              {% endif %}">
                    <i class="fas fa-id-card"></i>
                  </div>
                  <div class="{% if employee.twenty_hours %}
                                text-green-600
                              {% else %}
                                text-red-500
                              {% endif %}">
                    <span>20h</span>
                  </div>
                  <div class="{% if employee.sixty_hours %}
                                text-green-600
                              {% else %}
                                text-red-500
                              {% endif %}">
                    <span>60h</span>
                  </div>
                  <div class="{% if employee.confine %}
                                text-green-600
                              {% else %}
                                text-red-500
                              {% endif %}">
                    <i class="fas fa-square-person-confined"></i>
                  </div>
                  <div class="{% if employee.height %}
                                text-green-600
                              {% else %}
                                text-red-500
                              {% endif %}">
                    <i class="fas fa-person-falling"></i>
                  </div>

                  {% if employee.on_vacation %}
                  <div class="text-orange-500" title="De vacaciones">
                    <i class="fas fa-umbrella-beach text-xl"></i>
                  </div>
                  {% elif employee.near_upcoming_vacation %}
                  <div class="text-blue-500" title="Vacaciones próximas">
                    <i class="fas fa-umbrella-beach text-2xl"></i>
                  </div>
                  {% elif employee.upcoming_vacation %}
                  <div class="text-green-500" title="Vacaciones próximas">
                    <i class="fas fa-umbrella-beach text-2xl"></i>
                  </div>
                  {% elif employee.end_contract %}
                <div class="text-indigo-500" title="Contrato termina">
                    <i class="fas fa-skull-crossbones text-xl"></i>
                    <p class="text-sm text-violet-600">{{ employee.end_contract_date|date:'d/m/Y' }}</p>
                </div>
                  {% endif %}

                    
                </div>
              </div>
              
              {% endif %}
              {% endfor %}

            </div>

          </div>
          {% endif %}
          {% endfor %}
        </div>

      </div>

      <!-- PROYECTOS Section (Second Row) -->
      <div class="mb-6">
        <div class="section-title">
          <h3>
            <i class="fas fa-project-diagram mr-2 text-green-800"></i>
            <span class="text-green-800">PROYECTOS</span>
          </h3>
        </div>

        <div class="projects-container" id="proyectos-container">
          {% for project in projects %}
          {% if project.type|lower == 'project' %}
          <div class="project-column">
            
            <!-- Project Header -->
            <div class="project-header bg-lime-300 border-b-4
                     {% if project.manager == 'Jose Cuesta Mejías' %}
                      border-emerald-400

                    {% elif project.manager == 'Javier Marín Gimeno' %}
                      border-orange-400

                    {% elif project.manager == 'Guillermo Boscá Gómez' %}
                      border-yellow-400

                    {% elif project.manager == 'Miguel Ángel Martínez García' %}
                      border-violet-400

                    {% elif project.manager == 'Óscar López Valverde' %}
                      border-rose-500

                    {% else %}
                      border-gray-400

                    {% endif %}">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <h3 class="project-title text-green-800">{{ project.name }}</h3>
                  <div class="project-meta text-gray-600">
                    {% if project.date_from %}
                    <div class="text-xs">
                      <i class="fas fa-calendar mr-1"></i>
                      Desde: {{ project.date_from|date:'d/m/Y' }}
                    </div>
                    {% endif %}
                    {% if project.date_to %}
                    <div class="text-xs">
                      <i class="fas fa-calendar-check mr-1"></i>
                      Hasta: {{ project.date_to|date:'d/m/Y' }}
                    </div>
                    {% endif %}
                    {% if project.manager %}
                    <div class="text-xs font-medium mt-1">
                      <i class="fas fa-user-tie mr-1"></i>
                      {{ project.manager }}
                    </div>
                    {% endif %}
                    {% if project.description %}
                    <div class="text-xs font-medium mt-1 bg-lime-100">
                        <i class="fas fa-comment mr-1 text-lime-500"></i>
                      {{ project.description }}
                    </div>
                    {% endif %}
                    
                  </div>
                </div>
                <div class="flex flex-col items-end">
                  <a href="{% url 'project_detail' project.id %}" class="text-green-600 hover:text-green-800"><i
                      class="fas fa-external-link-alt text-sm"></i></a>
                </div>
              </div>
              <div class="flex items-center justify-between w-full mt-2 gap-1">
                          <a href="{% url 'project_detail' project.id %}" 
                             class="text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 flex-1 text-center" 
                             title="Ver detalles del proyecto">
                            <i class="fas fa-eye text-lg"></i>
                          </a>
                          <a href="{% url 'project_update' project.id %}" 
                             class="text-green-600 hover:text-green-800 p-1 rounded hover:bg-green-100 flex-1 text-center" 
                             title="Editar proyecto">
                            <i class="fas fa-edit text-lg"></i>
                          </a>
                          <a href="{% url 'project_assign_employees' project.id %}" 
                             class="text-purple-600 hover:text-purple-800 p-1 rounded hover:bg-purple-100 flex-1 text-center" 
                             title="Asignar empleados">
                            <i class="fas fa-user-plus text-lg"></i>
                          </a>
                          <a href="{% url 'employee_needed_create' %}?project_id={{ project.id }}" 
                             class="text-orange-600 hover:text-orange-800 p-1 rounded hover:bg-orange-100 flex-1 text-center" 
                             title="Crear necesidad de empleado">
                            <i class="fas fa-user-clock text-lg"></i>
                          </a>
                          <a href="{% url 'get_employee_locked_create' %}?project_id={{ project.id }}" 
                             class="text-indigo-600 hover:text-indigo-800 p-1 rounded hover:bg-indigo-100 flex-1 text-center" 
                             title="Reservar empleado">
                            <i class="fas fa-lock text-lg"></i>
                          </a>
                          <a href="{% url 'project_delete' project.id %}" 
                             class="text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 flex-1 text-center" 
                             title="Eliminar proyecto"
                             onclick="return confirm('¿Estás seguro de que quieres eliminar este proyecto?')">
                            <i class="fas fa-trash text-lg"></i>
                          </a>
                        </div>
            </div>

            <!-- Employees in this project -->
            <div class="kanban-column bg-lime-100" id="project-{{ project.id }}-column" data-project-id="{{ project.id }}">
              {% for need in needs %}
                    {% if need.project_id == project %}
                      <div class="need-card p-2 bg-red-300 border border-gray-300 rounded-md shadow-sm mb-2">
                        <div class="flex justify-between items-start">
                          <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-900">{{ need.get_type_display }}</h4>
                            <p class="text-sm text-gray-600">{{ need.quantity }} required</p>
                            {% if need.description %}
                              <p class="text-xs text-gray-700 mt-1 italic">{{ need.description|truncatewords:10 }}</p>
                            {% endif %}
                          </div>
                          <div class="flex flex-col items-end">
                            <p class="text-sm text-gray-500">{{ need.start_date }}</p>
                            {% if need.id %}
                              <div class="flex space-x-1 mt-1">
                                <a href="{% url 'employee_needed_update' need.id %}" class="text-rose-600 hover:text-gray-600" title="Edit request"><i class="fas fa-edit text-base"></i></a>
                                <a href="{% url 'employee_needed_fulfill' need.id %}" class="text-green-600 hover:text-green-800" title="Mark as fulfilled"><i class="fas fa-check-circle text-base"></i></a>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}

                  {% for lock in locks %}
                    {% if lock.next_project == project %}
                      <div class="lock-card p-2 bg-indigo-500 border border-gray-300 rounded-md shadow-sm mb-2">
                        <div class="justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-white">{{ lock.employee }}</h4>
                          </div>
                          <div>
                            <p class="text-sm text-gray-100 text-white">{{ lock.start_date }}</p>
                            <p class="text-sm text-gray-100 text-white">{{ lock.end_date }}</p>
                            {% if lock.id %}
                              <div class="flex space-x-2 ml-2">
                                <a href="{% url 'get_employee_locked_update' lock.id %}" class="text-white hover:text-gray-600" title="Edit request"><i class="fas fa-edit text-base"></i></a>
                                <a href="{% url 'get_employee_locked_fulfill' lock.id %}" class="text-lime-300 hover:text-green-800" title="Mark as fulfilled"><i class="fas fa-check-circle text-base"></i></a>
                                <a href="{% url 'get_employee_locked_delete' lock.id %}" 
                                  class="text-amber-400 hover:text-orange-700" 
                                  title="Delete lock"
                                  onclick="return confirm('¿Estás seguro de que quieres eliminar esta reserva?')">
                                  <i class="fas fa-trash text-base"></i>
                                </a>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
              {% for employee in employees %}
              {% if employee.project_id == project and employee.active %}
              <div class="employee-card 
                        {% if employee.locked == False %}
                            {% if 'Topógrafo' in employee.job or 'TOPÓGRAFO' in employee.job %}
                              
                            bg-green-300

                            {% elif 'Auxiliar' in employee.job or 'auxiliar' in employee.job %}
                              
                            bg-yellow-200

                            {% elif 'Proyectos' in employee.job or 'Proyecto' in employee.job %}
                              
                            bg-orange-300

                            {% elif 'Piloto' in employee.job or 'piloto' in employee.job %}
                              
                            bg-blue-300

                            {% else %}
                              
                            bg-green-100 hover:bg-green-200

                            {% endif %}
                          {% else %}
                            
                          bg-gray-200

                          {% endif %}
                      border border-gray-300 rounded-md shadow-sm mb-2 cursor-move"
                data-employee-id="{{ employee.id }}" draggable="true">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <h4 class="employee-name">{{ employee.name }}</h4>
                    <p class="employee-job">{{ employee.job }}</p>
                    {% if employee.city %}
                    <p class="text-xs text-gray-500 mt-1">
                      <i class="fas fa-map-marker-alt mr-1"></i>{{ employee.city }}
                    </p>
                    {% endif %}
                    {% if employee.end_date %}
                    <p class="text-xs text-red-600 mt-1">
                      <i class="fas fa-clock mr-1"></i>
                      Hasta: {{ employee.end_date|date:'d/m/Y' }}
                    </p>
                    {% endif %}
                  </div>
                  <div class="flex flex-col items-end">
                    <a href="{% url 'employee_update' employee.id %}" class="text-blue-600 hover:text-blue-800"><i
                        class="fas fa-external-link-alt text-xs"></i></a>
                  </div>
                </div>

                <!-- Employee skills indicators -->
                <div class="flex justify-between mt-2 text-xs">
                  <div class="{% if employee.driver_license %}
                                text-green-600
                              {% else %}
                                text-red-500
                              {% endif %}">
                    <i class="fas fa-id-card"></i>
                  </div>
                  <div class="{% if employee.twenty_hours %}
                                text-green-600
                              {% else %}
                                text-red-500
                              {% endif %}">
                    <span>20h</span>
                  </div>
                  <div class="{% if employee.sixty_hours %}
                                text-green-600
                              {% else %}
                                text-red-500
                              {% endif %}">
                    <span>60h</span>
                  </div>
                  <div class="{% if employee.confine %}
                                text-green-600
                              {% else %}
                                text-red-500
                              {% endif %}">
                    <i class="fas fa-square-person-confined"></i>
                  </div>
                  <div class="{% if employee.height %}
                                text-green-600
                              {% else %}
                                text-red-500
                              {% endif %}">
                    <i class="fas fa-person-falling"></i>
                  </div>

                  {% if employee.on_vacation %}
                  <div class="text-orange-500" title="De vacaciones">
                    <i class="fas fa-umbrella-beach text-xl"></i>
                  </div>
                  {% elif employee.upcoming_vacation %}
                  <div class="text-blue-500" title="Vacaciones próximas">
                    <i class="fas fa-umbrella-beach text-2xl"></i>
                  </div>
                  {% elif employee.end_contract %}
                <div class="text-indigo-500" title="Contrato termina">
                    <i class="fas fa-skull-crossbones text-xl"></i>
                    <p class="text-sm text-violet-600">{{ employee.end_contract_date|date:'d/m/Y' }}</p>
                </div>
                  {% endif %}
                </div>
              </div>
              {% endif %}
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% endfor %}
          
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading indicator -->
<div id="loading-indicator" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
  <div class="bg-white p-4 rounded-lg flex flex-col items-center">
    <svg class="animate-spin h-8 w-8 text-blue-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none"
      viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
      </path>
    </svg>
    <span class="text-gray-700">Actualizando...</span>
  </div>
</div>

<!-- Toast notification -->
<div id="toast-notification"
  class="fixed bottom-4 right-4 p-3 rounded-md shadow-lg text-white transform translate-y-full opacity-0 transition-all duration-300 z-50 text-sm">
</div>

<!-- CSRF Token for AJAX -->
{% csrf_token %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('🚀 Kanban Board inicializado')

    // Auto-refresh cada 60 segundos
    setInterval(function () {
      console.log('🔄 Auto-refreshing...')
      window.location.reload()
    }, 60000)

    // Función para mostrar notificaciones
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast-notification')
      toast.textContent = message
      toast.className = `fixed bottom-4 right-4 p-3 rounded-md shadow-lg text-white transition-all duration-300 z-50 text-sm ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`

      // Mostrar
      toast.style.transform = 'translateY(0)'
      toast.style.opacity = '1'

      // Ocultar después de 3 segundos
      setTimeout(() => {
        toast.style.transform = 'translateY(100%)'
        toast.style.opacity = '0'
      }, 3000)
    }

    // Asignar función global para usar desde drag_drop.js
    window.showToast = showToast
  })
</script>

<style>
  /* Estilos adicionales para mejor presentación */
  .alert {
    @apply px-3 py-2 rounded-md text-sm font-medium;
  }

  .alert-warning {
    @apply bg-yellow-100 text-yellow-800 border border-yellow-200;
  }

  .alert-info {
    @apply bg-blue-100 text-blue-800 border border-blue-200;
  }

  .stats-panel {
    @apply flex flex-col gap-2;
  }

  /* SCROLLBAR FORZADA PARA SIDEBAR */
  #unassigned-column,
  .kanban-sidebar .kanban-column {
    scrollbar-width: thick !important;
    scrollbar-color: #374151 #e5e7eb !important;
    overflow-y: scroll !important;
    overflow-x: hidden !important;
    min-height: 500px !important;
    max-height: calc(100vh - 250px) !important;
  }

  #unassigned-column::-webkit-scrollbar,
  .kanban-sidebar .kanban-column::-webkit-scrollbar {
    width: 18px !important;
    background-color: #e5e7eb !important;
    display: block !important;
    visibility: visible !important;
  }

  #unassigned-column::-webkit-scrollbar-track,
  .kanban-sidebar .kanban-column::-webkit-scrollbar-track {
    background: #f3f4f6 !important;
    border-radius: 9px !important;
    border: 3px solid #d1d5db !important;
    box-shadow: inset 0 0 6px rgba(0,0,0,0.3) !important;
  }

  #unassigned-column::-webkit-scrollbar-thumb,
  .kanban-sidebar .kanban-column::-webkit-scrollbar-thumb {
    background: #374151 !important;
    border-radius: 9px !important;
    border: 3px solid #f3f4f6 !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important;
    min-height: 50px !important;
  }

  #unassigned-column::-webkit-scrollbar-thumb:hover,
  .kanban-sidebar .kanban-column::-webkit-scrollbar-thumb:hover {
    background: #1f2937 !important;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5) !important;
  }

  /* Asegurar que el kanban sea responsive */
  @media (max-width: 768px) {
    .kanban-board {
      @apply flex-col;
    }

    .kanban-sidebar {
      @apply w-full max-h-64;
    }

    .projects-container {
      @apply flex-col;
    }

    .project-column {
      @apply w-full max-w-none;
    }
  }

  /* Efectos de drag and drop */
  .employee-card.dragging {
    @apply opacity-50 transform rotate-2;
  }

  .kanban-column.drag-over {
    @apply bg-blue-50 border-2 border-blue-300 border-dashed;
  }

  .project-column.highlight {
    @apply ring-2 ring-blue-400;
  }
</style>
{% endblock %}