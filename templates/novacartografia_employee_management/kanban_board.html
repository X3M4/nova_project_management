{% extends 'base.html' %}
{% load employee_filters %}

{% block title %}
  Kanban Board
{% endblock %}

{% block extra_css %}
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/kanban.css' %}" />
{% endblock %}

{% block extra_js %}
  {% load static %}
  <script src="{% static 'js/drag_drop.js' %}"></script>
{% endblock %}

{% block content %}
<div class="kanban-container">
  
  <!-- Header with search and controls -->
  <div class="kanban-header bg-white shadow-sm mb-4 p-4 rounded-lg">
    <div class="flex justify-between items-center">
      <div>
        <a href="{% url 'project_list' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded flex items-center text-sm">
          <i class="fas fa-th-list mr-2"></i> Project List
        </a>
      </div>

      <!-- Search Bar -->
      <div class="flex-1 max-w-md mx-6">
        <form method="GET" class="relative" id="search-form">
          <input type="text" name="search" value="{{ request.GET.search }}" 
                 id="search-input"
                 class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                 placeholder="Buscar proyectos, managers, empleados..." />
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400"></i>
          </div>
          {% if request.GET.search %}
            <a href="{% url 'kanban_board' %}" class="absolute inset-y-0 right-0 pr-3 flex items-center">
              <i class="fas fa-times text-gray-400 hover:text-gray-600"></i>
            </a>
          {% endif %}
        </form>
      </div>

      <!-- Statistics -->
      {% if stats.employees_ending_soon > 0 or stats.employees_on_vacation > 0 %}
      <div class="stats-panel">
        {% if stats.employees_ending_soon > 0 %}
          <div class="alert alert-warning text-sm">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="stat-ending-soon">{{ stats.employees_ending_soon }}</span> empleado{{ stats.employees_ending_soon|pluralize }} terminando pronto
          </div>
        {% endif %}
        
        {% if stats.employees_on_vacation > 0 %}
          <div class="alert alert-info text-sm">
            <i class="fas fa-umbrella-beach"></i>
            <span id="stat-on-vacation">{{ stats.employees_on_vacation }}</span> empleado{{ stats.employees_on_vacation|pluralize }} de vacaciones
          </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Main Kanban Layout -->
  <div class="kanban-board">
    
    <!-- Sidebar with unassigned employees -->
    <div class="kanban-sidebar">
      <div class="p-4">
        <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">EL PUCHERO</h3>
        <div class="bg-white shadow rounded-lg overflow-hidden">
          <div class="bg-gray-100 px-3 py-2 border-b border-gray-200">
            <div class="flex justify-between items-center">
              <h4 class="text-sm font-medium text-gray-800">Disponibles</h4>
              <span class="bg-gray-200 text-xs font-medium rounded-full px-2 py-1 text-gray-800">
                ({{ employees|count_unassigned }})
              </span>
            </div>
          </div>
          <div class="kanban-column" id="unassigned-column" data-project-id="null">
            {% for employee in employees %}
              {% if not employee.project_id and employee.active %}
                <div class="employee-card {% if employee.locked == False %}bg-green-100 hover:bg-green-200{% else %}bg-gray-200{% endif %} border border-gray-300 rounded-md shadow-sm mb-2 cursor-move" 
                     data-employee-id="{{ employee.id }}" draggable="true">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <h4 class="employee-name">{{ employee.name }}</h4>
                      <p class="employee-job">{{ employee.job }}</p>
                      {% if employee.city %}
                        <p class="text-xs text-gray-500 mt-1">
                          <i class="fas fa-map-marker-alt mr-1"></i>{{ employee.city }}
                        </p>
                      {% endif %}
                    </div>
                    <div class="flex flex-col items-end">
                      <a href="{% url 'employee_update' employee.id %}" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-external-link-alt text-xs"></i>
                      </a>
                    </div>
                  </div>
                  
                  <!-- Employee skills indicators -->
                  <div class="flex justify-between mt-2 text-xs">
                    <div class="{% if employee.driver_license %}text-green-600{% else %}text-red-500{% endif %}">
                      <i class="fas fa-id-card"></i>
                    </div>
                    <div class="{% if employee.twenty_hours %}text-green-600{% else %}text-red-500{% endif %}">
                      <span>20h</span>
                    </div>
                    <div class="{% if employee.sixty_hours %}text-green-600{% else %}text-red-500{% endif %}">
                      <span>60h</span>
                    </div>
                    <div class="{% if employee.confine %}text-green-600{% else %}text-red-500{% endif %}">
                      <i class="fas fa-square-person-confined"></i>
                    </div>
                    <div class="{% if employee.height %}text-green-600{% else %}text-red-500{% endif %}">
                      <i class="fas fa-person-falling"></i>
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Main content with project boards -->
    <div class="kanban-main">
      
      <!-- OBRAS Section (First Row) -->
      <div class="mb-6">
        <div class="section-title">
          <h3>
            <i class="fas fa-hard-hat mr-2"></i>
            OBRAS
          </h3>
        </div>
        
        <div class="projects-container" id="obras-container">
          {% for project in projects %}
            {% if project.type|lower == 'external' %}
              <div class="project-column">
                <!-- Project Header -->
                <div class="project-header bg-violet-200 border-b-4
                     {% if project.manager == 'Jose Cuesta Mejías' %}border-emerald-400
                     {% elif project.manager == 'Javier Marín Gimeno' %}border-orange-400
                     {% elif project.manager == 'Guillermo Boscá Gómez' %}border-yellow-400
                     {% elif project.manager == 'Miguel Ángel Martínez García' %}border-violet-400
                     {% elif project.manager == 'Óscar López Valverde' %}border-rose-500
                     {% else %}border-gray-400
                     {% endif %}">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <h3 class="project-title text-violet-800">{{ project.name }}</h3>
                      <div class="project-meta text-gray-600">
                        {% if project.date_from %}
                          <div class="text-xs">
                            <i class="fas fa-calendar mr-1"></i>
                            Desde: {{ project.date_from|date:"d/m/Y" }}
                          </div>
                        {% endif %}
                        {% if project.date_to %}
                          <div class="text-xs">
                            <i class="fas fa-calendar-check mr-1"></i>
                            Hasta: {{ project.date_to|date:"d/m/Y" }}
                          </div>
                        {% endif %}
                        {% if project.manager %}
                          <div class="text-xs font-medium mt-1">
                            <i class="fas fa-user-tie mr-1"></i>
                            {{ project.manager }}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="flex flex-col items-end">
                      <a href="{% url 'project_detail' project.id %}" class="text-violet-600 hover:text-violet-800">
                        <i class="fas fa-external-link-alt text-sm"></i>
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Employees in this project -->
                <div class="kanban-column" id="project-{{ project.id }}-column" data-project-id="{{ project.id }}">
                  {% for employee in employees %}
                    {% if employee.project_id == project and employee.active %}
                      <div class="employee-card
                        {% if employee.locked == False %}
                          {% if 'Topógrafo' in employee.job or 'Topógrafa' in employee.job %}
                            bg-green-300
                          {% elif 'Auxiliar' in employee.job or 'auxiliar' in employee.job %}
                            bg-yellow-200
                          {% elif 'Proyectos' in employee.job or 'Proyecto' in employee.job %}
                            bg-orange-300
                          {% elif 'Piloto' in employee.job or 'piloto' in employee.job %}
                            bg-blue-300
                          {% else %}
                            bg-green-100 hover:bg-green-200
                          {% endif %}
                        {% else %}
                          bg-gray-200
                        {% endif %}
                        border border-gray-300 rounded-md shadow-sm mb-2 cursor-move"
                         data-employee-id="{{ employee.id }}" draggable="true">
                        <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <h4 class="employee-name">{{ employee.name }}</h4>
                          <p class="employee-job">{{ employee.job }}</p>
                          {% if employee.city %}
                          <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-map-marker-alt mr-1"></i>{{ employee.city }}
                          </p>
                          {% endif %}
                          {% if employee.end_date %}
                          <p class="text-xs text-red-600 mt-1">
                            <i class="fas fa-clock mr-1"></i>
                            Hasta: {{ employee.end_date|date:"d/m/Y" }}
                          </p>
                          {% endif %}
                        </div>
                        <div class="flex flex-col items-end">
                          <a href="{% url 'employee_update' employee.id %}" class="text-blue-600 hover:text-blue-800">
                          <i class="fas fa-external-link-alt text-xs"></i>
                          </a>
                        </div>
                        </div>
                        
                        <!-- Employee skills indicators -->
                        <div class="flex justify-between mt-2 text-xs">
                        <div class="{% if employee.driver_license %}text-green-600{% else %}text-red-500{% endif %}">
                          <i class="fas fa-id-card"></i>
                        </div>
                        <div class="{% if employee.twenty_hours %}text-green-600{% else %}text-red-500{% endif %}">
                          <span>20h</span>
                        </div>
                        <div class="{% if employee.sixty_hours %}text-green-600{% else %}text-red-500{% endif %}">
                          <span>60h</span>
                        </div>
                        <div class="{% if employee.confine %}text-green-600{% else %}text-red-500{% endif %}">
                          <i class="fas fa-square-person-confined"></i>
                        </div>
                        <div class="{% if employee.height %}text-green-600{% else %}text-red-500{% endif %}">
                          <i class="fas fa-person-falling"></i>
                        </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- PROYECTOS Section (Second Row) -->
      <div class="mb-6">
        <div class="section-title">
          <h3>
            <i class="fas fa-project-diagram mr-2"></i>
            PROYECTOS
          </h3>
        </div>
        
        <div class="projects-container" id="proyectos-container">
          {% for project in projects %}
            {% if project.type|lower == 'project' %}
              <div class="project-column">
                <!-- Project Header -->
                <div class="project-header bg-green-200 border-b-4
                     {% if project.manager == 'Jose Cuesta Mejías' %}border-emerald-400
                     {% elif project.manager == 'Javier Marín Gimeno' %}border-orange-400
                     {% elif project.manager == 'Guillermo Boscá Gómez' %}border-yellow-400
                     {% elif project.manager == 'Miguel Ángel Martínez García' %}border-violet-400
                     {% elif project.manager == 'Óscar López Valverde' %}border-rose-500
                     {% else %}border-gray-400
                     {% endif %}">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <h3 class="project-title text-green-800">{{ project.name }}</h3>
                      <div class="project-meta text-gray-600">
                        {% if project.date_from %}
                          <div class="text-xs">
                            <i class="fas fa-calendar mr-1"></i>
                            Desde: {{ project.date_from|date:"d/m/Y" }}
                          </div>
                        {% endif %}
                        {% if project.date_to %}
                          <div class="text-xs">
                            <i class="fas fa-calendar-check mr-1"></i>
                            Hasta: {{ project.date_to|date:"d/m/Y" }}
                          </div>
                        {% endif %}
                        {% if project.manager %}
                          <div class="text-xs font-medium mt-1">
                            <i class="fas fa-user-tie mr-1"></i>
                            {{ project.manager }}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="flex flex-col items-end">
                      <a href="{% url 'project_detail' project.id %}" class="text-green-600 hover:text-green-800">
                        <i class="fas fa-external-link-alt text-sm"></i>
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Employees in this project -->
                <div class="kanban-column" id="project-{{ project.id }}-column" data-project-id="{{ project.id }}">
                  {% for employee in employees %}
                    {% if employee.project_id == project and employee.active %}
                      <div class="employee-card {% if employee.locked == False %}bg-green-100 hover:bg-green-200{% else %}bg-gray-200{% endif %} border border-gray-300 rounded-md shadow-sm mb-2 cursor-move" 
                           data-employee-id="{{ employee.id }}" draggable="true">
                        <div class="flex justify-between items-start">
                          <div class="flex-1">
                            <h4 class="employee-name">{{ employee.name }}</h4>
                            <p class="employee-job">{{ employee.job }}</p>
                            {% if employee.city %}
                              <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-map-marker-alt mr-1"></i>{{ employee.city }}
                              </p>
                            {% endif %}
                            {% if employee.end_date %}
                              <p class="text-xs text-red-600 mt-1">
                                <i class="fas fa-clock mr-1"></i>
                                Hasta: {{ employee.end_date|date:"d/m/Y" }}
                              </p>
                            {% endif %}
                          </div>
                          <div class="flex flex-col items-end">
                            <a href="{% url 'employee_update' employee.id %}" class="text-blue-600 hover:text-blue-800">
                              <i class="fas fa-external-link-alt text-xs"></i>
                            </a>
                          </div>
                        </div>
                        
                        <!-- Employee skills indicators -->
                        <div class="flex justify-between mt-2 text-xs">
                          <div class="{% if employee.driver_license %}text-green-600{% else %}text-red-500{% endif %}">
                            <i class="fas fa-id-card"></i>
                          </div>
                          <div class="{% if employee.twenty_hours %}text-green-600{% else %}text-red-500{% endif %}">
                            <span>20h</span>
                          </div>
                          <div class="{% if employee.sixty_hours %}text-green-600{% else %}text-red-500{% endif %}">
                            <span>60h</span>
                          </div>
                          <div class="{% if employee.confine %}text-green-600{% else %}text-red-500{% endif %}">
                            <i class="fas fa-square-person-confined"></i>
                          </div>
                          <div class="{% if employee.height %}text-green-600{% else %}text-red-500{% endif %}">
                            <i class="fas fa-person-falling"></i>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Loading indicator -->
<div id="loading-indicator" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
  <div class="bg-white p-4 rounded-lg flex flex-col items-center">
    <svg class="animate-spin h-8 w-8 text-blue-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span class="text-gray-700">Actualizando...</span>
  </div>
</div>

<!-- Toast notification -->
<div id="toast-notification" class="fixed bottom-4 right-4 p-3 rounded-md shadow-lg text-white transform translate-y-full opacity-0 transition-all duration-300 z-50 text-sm"></div>

<!-- CSRF Token for AJAX -->
{% csrf_token %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Kanban Board inicializado');
    
    // Auto-refresh cada 60 segundos
    setInterval(function() {
        console.log('🔄 Auto-refreshing...');
        window.location.reload();
    }, 60000);
    
    // Función para mostrar notificaciones
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.className = `fixed bottom-4 right-4 p-3 rounded-md shadow-lg text-white transition-all duration-300 z-50 text-sm ${
            type === 'success' ? 'bg-green-500' : 
            type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        
        // Mostrar
        toast.style.transform = 'translateY(0)';
        toast.style.opacity = '1';
        
        // Ocultar después de 3 segundos
        setTimeout(() => {
            toast.style.transform = 'translateY(100%)';
            toast.style.opacity = '0';
        }, 3000);
    }
    
    // Asignar función global para usar desde drag_drop.js
    window.showToast = showToast;
});
</script>

<style>
/* Estilos adicionales para mejor presentación */
.alert {
    @apply px-3 py-2 rounded-md text-sm font-medium;
}

.alert-warning {
    @apply bg-yellow-100 text-yellow-800 border border-yellow-200;
}

.alert-info {
    @apply bg-blue-100 text-blue-800 border border-blue-200;
}

.stats-panel {
    @apply flex flex-col gap-2;
}

/* Asegurar que el kanban sea responsive */
@media (max-width: 768px) {
    .kanban-board {
        @apply flex-col;
    }
    
    .kanban-sidebar {
        @apply w-full max-h-64;
    }
    
    .projects-container {
        @apply flex-col;
    }
    
    .project-column {
        @apply w-full max-w-none;
    }
}

/* Efectos de drag and drop */
.employee-card.dragging {
    @apply opacity-50 transform rotate-2;
}

.kanban-column.drag-over {
    @apply bg-blue-50 border-2 border-blue-300 border-dashed;
}

.project-column.highlight {
    @apply ring-2 ring-blue-400;
}
</style>

{% endblock %}
