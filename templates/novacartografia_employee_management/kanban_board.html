<!-- filepath: /home/p102/django_projects/nova_workers_management/templates/novacartografia_employee_management/kanban_board.html -->
{% extends 'base.html' %}
{% load custom_tags %}

{% block title %}
  Kanban Board
{% endblock %}

{% block extra_css %}
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/kanban.css' %}" />
{% endblock %}

{% block content %}
  <div class="kanban-header">
    <div class="flex justify-between items-center">
      <div>
        <h2 class="text-xl font-bold text-gray-800">Kanban Board</h2>
        <p class="text-sm text-gray-600">Drag and drop employees between projects</p>
      </div>

      <!-- Search Bar -->
    <div class="flex-1 max-w-md md:ml-6 mt-4 md:mt-0">
      <form method="GET" class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-gray-400"></i>
          </div>
          <input 
              type="text" 
              name="search" 
              value="{{ request.GET.search }}"
              placeholder="Search projects by name, manager..." 
              class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
          >
          {% if request.GET.search %}
              <a href="{% url 'kanban_board' %}" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                  <i class="fas fa-times text-gray-400 hover:text-gray-600"></i>
              </a>
          {% endif %}
      </form>
  </div>
      
      <div>
        <a href="{% url 'project_list' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-1 px-3 rounded flex items-center text-sm"><i class="fas fa-th-list mr-1"></i> Project List</a>
      </div>
    </div>

    <!-- Mobile toggle for sidebar -->
    <button class="toggle-sidebar w-full bg-gray-100 py-1 px-4 text-left mt-2 rounded flex justify-between items-center md:hidden text-sm">
      <span>Unassigned Employees</span>
      <i class="fas fa-chevron-down"></i>
    </button>
  </div>

  <!-- Main layout with sidebar -->
  <div class="kanban-layout mb-28">
    <!-- Sidebar with unassigned employees -->
    <div class=" bg-gray-50 shadow-lg rounded-lg p-4 mb-4 md:mb-0 max-w-72">
      <div >
        <h3 class="text-md font-bold text-gray-700 mb-2">Unassigned Employees</h3>
        <div class="bg-white shadow rounded-lg">
          <div class="bg-gray-100 px-3 py-1 border-b border-gray-200 rounded-t-lg">
            <div class="flex justify-between items-center">
              <div>
                <h3 class="text-sm font-medium text-gray-800">Employees Pool</h3>
                <p class="text-xs text-gray-500">Drag to assign</p>
              </div>
              <span class="bg-gray-200 text-xs font-medium rounded-full px-2 py-1 text-gray-800"><span class="text-sm text-gray-600">({{ employees|count_unassigned }})</span></span>
            </div>
          </div>
          <div class="p-3 kanban-column" id="project-{{ project.id }}-column" data-project-id="{{ project.id }}" style="max-height: calc(100vh - 240px); overflow-y: auto; overflow-x: hidden;">
            {% for employee in employees %}
              {% if employee.project_id == project and 'TOPÓGRAFO' in employee.job or 'Topógrafo' in employee.job %}
                <div class="employee-card p-2 {% if employee.locked == False %} bg-green-200 {% else %} bg-gray-300 {% endif %}  border border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                  <div class="flex justify-between items-start">
                    <div>
                      <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                      <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                    </div>
                    <a href="{% url 'employee_detail' employee.id %}" class="text-green-500 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                  </div>
                  <div class="flex justify-between">
                    <div class="{% if employee.driver_license == False %}
                        text-red-500
                      {% else %}
                         text-green-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-id-card text-base"></i>
                    </div>
                    <div class="{% if employee.twenty_hours %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-2 text-base"></i>
                      <i class="fa-solid fa-0 text-base"></i>
                    </div>
                    <div class="{% if employee.sixty_hours %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-6 text-base"></i>
                      <i class="fa-solid fa-0 text-base"></i>
                    </div>
                    <div class="{% if employee.confine %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-square-person-confined text-base"></i>
                    </div>
                    <div class="{% if employee.height %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-person-falling text-base"></i>
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if employee.project_id == project and 'Auxiliar' in employee.job or employee.project_id == project and 'Técnico GIS' in employee.job %}
                <div class="employee-card p-2  bg-yellow-200 border  border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                  <div class="flex justify-between items-start">
                    <div>
                      <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                      <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                    </div>
                    <a href="{% url 'employee_detail' employee.id %}" class="text-yellow-500 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                  </div>
                  <div class="flex justify-between">
                    <div class="{% if employee.driver_license == False %}
                        text-red-500
                      {% else %}
                         text-green-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-id-card text-base"></i>
                    </div>
                    <div class="{% if employee.twenty_hours %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-2 text-base"></i>
                      <i class="fa-solid fa-0 text-base"></i>
                    </div>
                    <div class="{% if employee.sixty_hours %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-6 text-base"></i>
                      <i class="fa-solid fa-0 text-base"></i>
                    </div>
                    <div class="{% if employee.confine %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-square-person-confined text-base"></i>
                    </div>
                    <div class="{% if employee.height %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-person-falling text-base"></i>
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if employee.project_id == project and 'Piloto' in employee.job %}
                <div class="employee-card p-2 bg-blue-200 border border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                  <div class="flex justify-between items-start">
                    <div>
                      <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                      <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                    </div>
                    <a href="{% url 'employee_detail' employee.id %}" class="text-blue-600 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                  </div>
                  <div class="flex justify-between">
                    <div class="{% if employee.driver_license == False %}
                        text-red-500
                      {% else %}
                         text-green-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-id-card text-base"></i>
                    </div>
                    <div class="{% if employee.twenty_hours %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-2 text-base"></i>
                      <i class="fa-solid fa-0 text-base"></i>
                    </div>
                    <div class="{% if employee.sixty_hours %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-6 text-base"></i>
                      <i class="fa-solid fa-0 text-base"></i>
                    </div>
                    <div class="{% if employee.confine %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-square-person-confined text-base"></i>
                    </div>
                    <div class="{% if employee.height %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-person-falling text-base"></i>
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if employee.project_id == project and 'Proyectos' in employee.job %}
                <div class="employee-card p-2 bg-orange-300 border border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                  <div class="flex justify-between items-start">
                    <div>
                      <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                      <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                    </div>
                    <a href="{% url 'employee_detail' employee.id %}" class="text-orange-600 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                  </div>
                  <div class="flex justify-between">
                    <div class="{% if employee.driver_license == False %}
                        text-red-500
                      {% else %}
                         text-green-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-id-card text-base"></i>
                    </div>
                    <div class="{% if employee.twenty_hours %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-2 text-base"></i>
                      <i class="fa-solid fa-0 text-base"></i>
                    </div>
                    <div class="{% if employee.sixty_hours %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-6 text-base"></i>
                      <i class="fa-solid fa-0 text-base"></i>
                    </div>
                    <div class="{% if employee.confine %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-square-person-confined text-base"></i>
                    </div>
                    <div class="{% if employee.height %}
                        text-green-600
                      {% else %}
                        text-red-500
                      {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                      <i class="fa-solid fa-person-falling text-base"></i>
                    </div>
                  </div>
                </div>
              {% endif %}
            {% empty %}
              <p class="text-xs text-gray-500 italic">No employees assigned</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Main content with project boards -->
    <div class="main-content">
      <!-- Obras Projects (Top Row) -->
      <div class="mb-4">
        <!-- Reduced from mb-8 -->
        <div class="section-title">
          <h3 class="text-md font-bold text-violet-700">Obras</h3> <!-- Reduced size -->
        </div>
        <div class="projects-container">
          {% for project in projects %}
            {% if project.type|lower == 'external' %}
              <div class="project-column bg-violet-100 shadow rounded-lg">
                <div class="bg-violet-200 px-3 py-1 border-b-4 {% if project.manager == 'Jose Cuesta Mejías' %} border-emerald-400 {% elif project.manager == 'Javier Marín Gimeno' %} border-orange-400 {% elif project.manager == 'Guillermo Boscá Gómez' %} border-yellow-400 {% elif project.manager == 'Miguel Ángel Martínez García' %} border-violet-400 {% elif project.manager == 'Óscar López Valverde' %} border-rose-500 {% endif %} rounded-t-lg">
                  <!-- Reduced py-2 to py-1 -->
                  <div class="justify-between items-center">
                    <div>
                      <h3 class="text-sm font-medium text-rose-700">{{ project.name }}</h3>
                    </div>
                    <div class="flex space-x-3">
                      <a href="{% url 'project_detail' project.id %}" class="text-rose-500 hover:text-rose-700"><i class="fas fa-eye text-base"></i></a>
                      <a href="{% url 'employee_needed_create_from_project' project.id %}" class="text-rose-500 hover:text-rose-700"><i class="fas fa-triangle-exclamation text-base"></i></a>
                      <a href="{% url 'get_employee_locked_create_from_project' project.id %}" class="text-rose-500 hover:text-rose-700" title="Lock employee for future assignment"><i class="fas fa-user-lock text-base"></i></a>
                    </div>
                  </div>
                </div>
                <div class="p-3 kanban-column" id="project-{{ project.id }}-column" data-project-id="{{ project.id }}" style="max-height: calc(100vh - 240px); overflow-y: auto; overflow-x: hidden;">
                  {% for employee in employees %}
                    {% if employee.project_id == project and 'TOPÓGRAFO' in employee.job or employee.project_id == project and 'Topógrafo' in employee.job %}
                      <div class="employee-card p-2 bg-green-200 border border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                        <div class="flex justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                            <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                          </div>
                          <a href="{% url 'employee_detail' employee.id %}" class="text-green-500 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                        </div>
                        <div class="flex justify-between">
                          <div class="{% if employee.driver_license == False %}
                              text-red-500
                            {% else %}
                               text-green-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-id-card text-base"></i>
                          </div>
                          <div class="{% if employee.twenty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-2 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.sixty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-6 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.confine %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-square-person-confined text-base"></i>
                          </div>
                          <div class="{% if employee.height %}
                        text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-person-falling text-base"></i>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {% if employee.project_id == project and 'Auxiliar' in employee.job or employee.project_id == project and 'Técnico GIS' in employee.job %}
                      <div class="employee-card p-2 bg-yellow-200 border border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                        <div class="flex justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                            <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                          </div>
                          <a href="{% url 'employee_detail' employee.id %}" class="text-yellow-500 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                        </div>
                        <div class="flex justify-between">
                          <div class="{% if employee.driver_license == False %}
                              text-red-500
                            {% else %}
                               text-green-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-id-card text-base"></i>
                          </div>
                          <div class="{% if employee.twenty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-2 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.sixty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-6 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.confine %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-square-person-confined text-base"></i>
                          </div>
                          <div class="{% if employee.height %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-person-falling text-base"></i>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {% if employee.project_id == project and 'Piloto' in employee.job %}
                      <div class="employee-card p-2 bg-blue-200 border border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                        <div class="flex justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                            <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                          </div>
                          <a href="{% url 'employee_detail' employee.id %}" class="text-blue-600 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                        </div>
                        <div class="flex justify-between">
                          <div class="{% if employee.driver_license == False %}
                              text-red-500
                            {% else %}
                               text-green-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-id-card text-base"></i>
                          </div>
                          <div class="{% if employee.twenty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-2 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.sixty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-6 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.confine %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-square-person-confined text-base"></i>
                          </div>
                          <div class="{% if employee.height %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-person-falling text-base"></i>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {% if employee.project_id == project and 'Proyectos' in employee.job %}
                      <div class="employee-card p-2 bg-orange-300 border border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                        <div class="flex justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                            <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                          </div>
                          <a href="{% url 'employee_detail' employee.id %}" class="text-orange-600 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                        </div>
                        <div class="flex justify-between">
                          <div class="{% if employee.driver_license == False %}
                              text-red-500
                            {% else %}
                               text-green-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-id-card text-base"></i>
                          </div>
                          <div class="{% if employee.twenty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-2 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.sixty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-6 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.confine %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-square-person-confined text-base"></i>
                          </div>
                          <div class="{% if employee.height %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-person-falling text-base"></i>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% empty %}
                    <p class="text-xs text-gray-500 italic">No employees assigned</p>
                  {% endfor %}

                  {% for need in needs %}
                    {% if need.project_id == project %}
                      <div class="need-card p-2 bg-red-300 border border-gray-300 rounded-md shadow-sm mb-2">
                        <div class="flex justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-900">{{ need.get_type_display }}</h4>
                            <p class="text-sm text-gray-600">{{ need.quantity }} required</p>
                          </div>
                          <div>
                            <p class="text-sm text-gray-500">{{ need.start_date }}</p>
                            {% if need.id %}
                              <div class="flex space-x-1">
                                <a href="{% url 'employee_needed_update' need.id %}" class="text-rose-600 hover:text-gray-600" title="Edit request"><i class="fas fa-edit text-base"></i></a>
                                <a href="{% url 'employee_needed_fulfill' need.id %}" class="text-green-600 hover:text-green-800" title="Mark as fulfilled"><i class="fas fa-check-circle text-base"></i></a>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                  
                  {% for lock in locks %}
                    {% if lock.next_project == project %}
                      <div class="lock-card p-2 bg-indigo-500 border border-gray-300 rounded-md shadow-sm mb-2">
                        <div class="justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-50">{{ lock.employee }}</h4>
                          </div>
                          <div>
                            <p class="text-sm text-gray-100">{{ lock.start_date }}</p>
                            {% if lock.id %}
                              <div class="flex space-x-1">
                                <a href="{% url 'get_employee_locked_update' lock.id %}" class="text-white hover:text-gray-600" title="Edit request"><i class="fas fa-edit text-base"></i></a>
                                <a href="{% url 'get_employee_locked_fulfill' lock.id %}" class="text-green-200 hover:text-green-800" title="Mark as fulfilled"><i class="fas fa-check-circle text-base"></i></a>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                  
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- Proyectos (Bottom Row) -->
      <div class="mb-4">
        <!-- Reduced from mb-8 -->
        <div class="section-title">
          <h3 class="text-md font-bold text-green-700">Obras</h3> <!-- Reduced size -->
        </div>
        <div class="projects-container">
          {% for project in projects %}
            {% if project.type|lower == 'project' %}
              <div class="project-column bg-lime-100 shadow rounded-lg">
                <div class="bg-lime-300 px-3 py-1 border-b-4 {% if project.manager == 'Jose Cuesta Mejías' %} border-emerald-400 {% elif project.manager == 'Javier Marín Gimeno' %} border-orange-400 {% elif project.manager == 'Guillermo Boscá Gómez' %} border-yellow-400 {% elif project.manager == 'Miguel Ángel Martínez García' %} border-violet-400 {% elif project.manager == 'Óscar López Valverde' %} border-rose-500 {% endif %} rounded-t-lg">
                  <!-- Reduced py-2 to py-1 -->
                  <div class="justify-between items-center">
                    <div>
                      <h3 class="text-sm font-medium text-green-700">{{ project.name }}</h3>
                    </div>
                    <div class="flex space-x-3">
                      <a href="{% url 'project_detail' project.id %}" class="text-green-500 hover:text-green-700"><i class="fas fa-eye text-base"></i></a>
                      <a href="{% url 'employee_needed_create_from_project' project.id %}" class="text-green-500 hover:text-green-700"><i class="fas fa-triangle-exclamation text-base"></i></a>
                      <a href="{% url 'get_employee_locked_create_from_project' project.id %}" class="text-green-500 hover:text-green-700" title="Lock employee for future assignment"><i class="fas fa-user-lock text-base"></i></a>
                    </div>
                  </div>
                </div>
                <div class="p-3 kanban-column" id="project-{{ project.id }}-column" data-project-id="{{ project.id }}" style="max-height: calc(100vh - 240px); overflow-y: auto; overflow-x: hidden;">
                  {% for employee in employees %}
                    {% if employee.project_id == project and 'TOPÓGRAFO' in employee.job or employee.project_id == project and 'Topógrafo' in employee.job %}
                      <div class="employee-card p-2 bg-green-200 border border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                        <div class="flex justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                            <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                          </div>
                          <a href="{% url 'employee_detail' employee.id %}" class="text-green-500 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                        </div>
                        <div class="flex justify-between">
                          <div class="{% if employee.driver_license == False %}
                              text-red-500
                            {% else %}
                               text-green-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-id-card text-base"></i>
                          </div>
                          <div class="{% if employee.twenty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-2 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.sixty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-6 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.confine %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-square-person-confined text-base"></i>
                          </div>
                          <div class="{% if employee.height %}
                        text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-person-falling text-base"></i>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {% if employee.project_id == project and 'Auxiliar' in employee.job or employee.project_id == project and 'Técnico GIS' in employee.job %}
                      <div class="employee-card p-2 bg-yellow-200 border border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                        <div class="flex justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                            <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                          </div>
                          <a href="{% url 'employee_detail' employee.id %}" class="text-yellow-500 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                        </div>
                        <div class="flex justify-between">
                          <div class="{% if employee.driver_license == False %}
                              text-red-500
                            {% else %}
                               text-green-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-id-card text-base"></i>
                          </div>
                          <div class="{% if employee.twenty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-2 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.sixty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-6 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.confine %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-square-person-confined text-base"></i>
                          </div>
                          <div class="{% if employee.height %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-person-falling text-base"></i>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {% if employee.project_id == project and 'Piloto' in employee.job %}
                      <div class="employee-card p-2 bg-blue-200 border border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                        <div class="flex justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                            <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                          </div>
                          <a href="{% url 'employee_detail' employee.id %}" class="text-blue-600 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                        </div>
                        <div class="flex justify-between">
                          <div class="{% if employee.driver_license == False %}
                              text-red-500
                            {% else %}
                               text-green-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-id-card text-base"></i>
                          </div>
                          <div class="{% if employee.twenty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-2 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.sixty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-6 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.confine %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-square-person-confined text-base"></i>
                          </div>
                          <div class="{% if employee.height %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-person-falling text-base"></i>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {% if employee.project_id == project and 'Proyectos' in employee.job %}
                      <div class="employee-card p-2 bg-orange-300 border border-gray-200 rounded-md shadow-sm mb-2" data-employee-id="{{ employee.id }}" draggable="true">
                        <div class="flex justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-900">{{ employee.name }}</h4>
                            <p class="text-xs text-gray-500">{{ employee.get_state_display }}</p>
                          </div>
                          <a href="{% url 'employee_detail' employee.id %}" class="text-orange-600 hover:text-gray-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                        </div>
                        <div class="flex justify-between">
                          <div class="{% if employee.driver_license == False %}
                              text-red-500
                            {% else %}
                               text-green-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-id-card text-base"></i>
                          </div>
                          <div class="{% if employee.twenty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-2 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.sixty_hours %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-6 text-base"></i>
                            <i class="fa-solid fa-0 text-base"></i>
                          </div>
                          <div class="{% if employee.confine %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-square-person-confined text-base"></i>
                          </div>
                          <div class="{% if employee.height %}
                              text-green-600
                            {% else %}
                              text-red-500
                            {% endif %} mr-3 flex-shrink-0 w-3 h-4 flex items-center justify-center">
                            <i class="fa-solid fa-person-falling text-base"></i>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% empty %}
                    <p class="text-xs text-gray-500 italic">No employees assigned</p>
                  {% endfor %}

                  {% for need in needs %}
                    {% if need.project_id == project %}
                      <div class="need-card p-2 bg-red-300 border border-gray-300 rounded-md shadow-sm mb-2">
                        <div class="flex justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-900">{{ need.get_type_display }}</h4>
                            <p class="text-sm text-gray-600">{{ need.quantity }} required</p>
                          </div>
                          <div>
                            <p class="text-sm text-gray-500">{{ need.start_date }}</p>
                            {% if need.id %}
                              <div class="flex space-x-1">
                                <a href="{% url 'employee_needed_update' need.id %}" class="text-rose-600 hover:text-gray-600" title="Edit request"><i class="fas fa-edit text-base"></i></a>
                                <a href="{% url 'employee_needed_fulfill' need.id %}" class="text-green-600 hover:text-green-800" title="Mark as fulfilled"><i class="fas fa-check-circle text-base"></i></a>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                  
                  {% for lock in locks %}
                    {% if lock.next_project == project %}
                      <div class="lock-card p-2 bg-indigo-500 border border-gray-300 rounded-md shadow-sm mb-2">
                        <div class="justify-between items-start">
                          <div>
                            <h4 class="text-sm font-medium text-gray-50">{{ lock.employee }}</h4>
                          </div>
                          <div>
                            <p class="text-sm text-gray-100">{{ lock.start_date }}</p>
                            {% if lock.id %}
                              <div class="flex space-x-1">
                                <a href="{% url 'get_employee_locked_update' lock.id %}" class="text-white hover:text-gray-600" title="Edit request"><i class="fas fa-edit text-base"></i></a>
                                <a href="{% url 'get_employee_locked_fulfill' lock.id %}" class="text-green-200 hover:text-green-800" title="Mark as fulfilled"><i class="fas fa-check-circle text-base"></i></a>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                  
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Loading spinner -->
  <div id="loading-indicator" class="fixed inset-0 flex items-center justify-center  bg-opacity-50 z-50 hidden">
    <div class="bg-white p-4 rounded-lg flex flex-col items-center">
      <svg class="animate-spin h-8 w-8 text-blue-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </div>
  </div>

  <!-- Toast notification -->
  <div id="toast-notification" class="fixed bottom-4 right-4 p-3 rounded-md shadow-lg text-white transform translate-y-full opacity-0 transition-all duration-300 z-50 text-sm"></div>

  <!-- CSRF Token for AJAX -->
  <!-- CSRF Token for AJAX -->
{% csrf_token %}


<!-- CSRF Token for AJAX -->
{% csrf_token %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Corregir específicamente el problema de las barras de desplazamiento duplicadas
    const sidebar = document.querySelector('.sidebar');
    const sidebarContent = sidebar.querySelector('.p-4');
    const employeesPool = sidebar.querySelector('.bg-white.shadow.rounded-lg');
    
    if (sidebar && sidebarContent && employeesPool) {
      // Forzar que el sidebar principal NO tenga scroll
      sidebar.style.overflow = 'hidden';
      
      // Forzar que el contenedor intermedio tampoco tenga scroll
      sidebarContent.style.overflow = 'hidden';
      sidebarContent.style.height = '100%';
      
      // Solo permitir scroll en el contenedor de empleados
      employeesPool.style.maxHeight = 'calc(100vh - 220px)';
      employeesPool.style.overflowY = 'auto';
      employeesPool.style.overflowX = 'hidden';
      
      // Esto es importante para que la barra sea más estrecha
      const styleElement = document.createElement('style');
      styleElement.textContent = `
        .sidebar .bg-white.shadow.rounded-lg::-webkit-scrollbar {
          width: 4px !important;
          height: 4px !important;
        }
        .sidebar .bg-white.shadow.rounded-lg::-webkit-scrollbar-thumb {
          background-color: rgba(156, 163, 175, 0.5) !important;
          border-radius: 4px !important;
        }
      `;
      document.head.appendChild(styleElement);
      
      console.log('Barras de desplazamiento corregidas en la sidebar');
    }
  });
</script>
{% endblock %}

{% block extra_js %}
  {% load static %}
  <script src="{% static 'js/kanban.js' %}"></script>
  <!-- Añade SortableJS antes de tus scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- Reemplaza el script original por el nuevo -->
  <script src="{% static 'js/touch_kanban.js' %}"></script>
{% endblock %}

